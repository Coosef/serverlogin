# Kullanƒ±cƒ± Aktivite ƒ∞zleme Sistemi - Windows Server
# Tek Komutla Otomatik Kurulum
# Kullanƒ±m: PowerShell'i Y√∂netici olarak a√ßƒ±n ve √ßalƒ±≈ütƒ±rƒ±n:
#   .\install_windows.ps1
# Veya: Invoke-WebRequest -Uri "https://your-domain.com/install_windows.ps1" -OutFile install.ps1; .\install.ps1

$ErrorActionPreference = "Stop"

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Kullanƒ±cƒ± Aktivite ƒ∞zleme Sistemi" -ForegroundColor Cyan
Write-Host "Windows - Otomatik Kurulum" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# Y√∂netici kontrol√º
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
if (-not $isAdmin) {
    Write-Host "[HATA] Bu script Y√ñNETƒ∞Cƒ∞ olarak √ßalƒ±≈ütƒ±rƒ±lmalƒ±dƒ±r!" -ForegroundColor Red
    Write-Host "PowerShell'i 'Y√∂netici olarak √ßalƒ±≈ütƒ±r' ile a√ßƒ±n." -ForegroundColor Yellow
    exit 1
}

# Yapƒ±landƒ±rma
$InstallDir = "C:\ProgramData\user_activity_monitor"
$ScriptPath = "$InstallDir\user_activity_monitor.py"
$EnvPath = "$InstallDir\user_activity_monitor.env"
$ServiceName = "UserActivityMonitor"
$NSSMPath = "$InstallDir\nssm.exe"
$LogDir = "$InstallDir\logs"

Write-Host "[1/8] Python kontrol ediliyor..." -ForegroundColor Yellow
try {
    $pythonVersion = python --version 2>&1
    if ($LASTEXITCODE -ne 0) {
        throw "Python bulunamadƒ±"
    }
    Write-Host "       Python bulundu: $pythonVersion" -ForegroundColor Green
    $pythonPath = (Get-Command python).Source
    Write-Host "       Python yolu: $pythonPath" -ForegroundColor Gray
} catch {
    Write-Host "[HATA] Python bulunamadƒ±!" -ForegroundColor Red
    Write-Host "       L√ºtfen Python 3.x kurun: https://www.python.org/downloads/" -ForegroundColor Yellow
    Write-Host "       Kurulum sƒ±rasƒ±nda 'Add Python to PATH' se√ßeneƒüini i≈üaretleyin." -ForegroundColor Yellow
    exit 1
}

Write-Host ""
Write-Host "[2/8] Python paketleri kontrol ediliyor..." -ForegroundColor Yellow
try {
    $null = python -c "import requests" 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "       ‚úì requests y√ºkl√º" -ForegroundColor Green
    } else {
        Write-Host "       requests kuruluyor..." -ForegroundColor Yellow
        python -m pip install requests --quiet
        Write-Host "       ‚úì requests kuruldu" -ForegroundColor Green
    }
} catch {
    Write-Host "[HATA] Paket kurulumu ba≈üarƒ±sƒ±z!" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "[3/8] Kurulum klas√∂r√º olu≈üturuluyor..." -ForegroundColor Yellow
if (-not (Test-Path $InstallDir)) {
    New-Item -ItemType Directory -Path $InstallDir -Force | Out-Null
    Write-Host "       Klas√∂r olu≈üturuldu: $InstallDir" -ForegroundColor Green
} else {
    Write-Host "       Klas√∂r zaten var: $InstallDir" -ForegroundColor Gray
}

if (-not (Test-Path $LogDir)) {
    New-Item -ItemType Directory -Path $LogDir -Force | Out-Null
}

Write-Host ""
Write-Host "[4/8] Python scripti olu≈üturuluyor..." -ForegroundColor Yellow

# Python script i√ßeriƒüi (base64 encoded - PowerShell parser sorunlarƒ±nƒ± √∂nlemek i√ßin)
# Single here-string formatƒ±nda (array parser sorunlarƒ±nƒ± √∂nlemek i√ßin)
$pythonScriptBase64 = @'
IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiIKS2Fwc2FtbMSxIEt1bGxhbsSxY8SxIEFrdGl2aXRl
IMSwemxlbWUgU2lzdGVtaSAtIFdpbmRvd3MgU2VydmVyClTDvG0ga3VsbGFuxLFjxLEgYWt0aXZp
dGVsZXJpbmkgaXpsZXI6IGxvZ2luLCBsb2dvdXQsIHByb2Nlc3MsIGZpbGUgYWNjZXNzLCByZWdp
c3RyeQoiIiIKCmltcG9ydCBvcwppbXBvcnQgcmUKaW1wb3J0IGpzb24KaW1wb3J0IHRpbWUKaW1w
b3J0IHNvY2tldAppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgbG9nZ2luZwppbXBvcnQgdGhyZWFk
aW5nCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lLCB0aW1lem9uZQpmcm9tIGNvbGxlY3Rp
b25zIGltcG9ydCBkZWZhdWx0ZGljdCwgZGVxdWUKCnRyeToKICAgIGltcG9ydCByZXF1ZXN0cwpl
eGNlcHQgSW1wb3J0RXJyb3I6CiAgICBwcmludCgiW0VSUk9SXSAncmVxdWVzdHMnIHBha2V0aSBi
dWx1bmFtYWTEsS4gTMO8dGZlbiAncGlwIGluc3RhbGwgcmVxdWVzdHMnIMOnYWzEscWfdMSxcsSx
bi4iKQogICAgZXhpdCgxKQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09CiMgIFlhcMSxbGFu
ZMSxcm1hCiMgPT09PT09PT09PT09PT09PT09PT09PT09PQoKRU5WX1BBVEggPSByIkM6XFByb2dy
YW1EYXRhXHVzZXJfYWN0aXZpdHlfbW9uaXRvclx1c2VyX2FjdGl2aXR5X21vbml0b3IuZW52IgpM
T0dfRElSID0gciJDOlxQcm9ncmFtRGF0YVx1c2VyX2FjdGl2aXR5X21vbml0b3JcbG9ncyIKTE9H
X0ZJTEUgPSBvcy5wYXRoLmpvaW4oTE9HX0RJUiwgImFjdGl2aXR5X21vbml0b3IubG9nIikKCiMg
TG9nZ2luZyB5YXDEsWxhbmTEsXJtYXPEsQpvcy5tYWtlZGlycyhMT0dfRElSLCBleGlzdF9vaz1U
cnVlKQpsb2dnaW5nLmJhc2ljQ29uZmlnKAogICAgbGV2ZWw9bG9nZ2luZy5JTkZPLAogICAgZm9y
bWF0PSJbJShhc2N0aW1lKXNdIFslKGxldmVsbmFtZSlzXSAlKG1lc3NhZ2UpcyIsCiAgICBoYW5k
bGVycz1bCiAgICAgICAgbG9nZ2luZy5GaWxlSGFuZGxlcihMT0dfRklMRSwgZW5jb2Rpbmc9InV0
Zi04IiksCiAgICAgICAgbG9nZ2luZy5TdHJlYW1IYW5kbGVyKCkKICAgIF0KKQoKIyBXaW5kb3dz
IEV2ZW50IElEJ2xlcmkKRVZFTlRfTE9HT05fU1VDQ0VTUyA9IDQ2MjQKRVZFTlRfTE9HT05fRkFJ
TEVEID0gNDYyNQpFVkVOVF9MT0dPRkYgPSA0NjM0CkVWRU5UX0FDQ09VTlRfTE9DS0VEID0gNDc0
MApFVkVOVF9QUk9DRVNTX0NSRUFURSA9IDQ2ODgKRVZFTlRfRklMRV9BQ0NFU1MgPSA0NjYzICAj
IE9iamVjdCBBY2Nlc3MgKEZpbGUpCkVWRU5UX1JFR0lTVFJZX0FDQ0VTUyA9IDQ2NTcgICMgUmVn
aXN0cnkgQWNjZXNzCgojIElQIC0+IHNvbiBoYXRhbMSxIGRlbmVtZWxlcmluIHphbWFubGFyxLEK
ZmFpbF9ldmVudHMgPSBkZWZhdWx0ZGljdChkZXF1ZSkKCgojID09PT09PT09PT09PT09PT09PT09
PT09PT0KIyAgWWFyZMSxbWPEsSBGb25rc2l5b25sYXIKIyA9PT09PT09PT09PT09PT09PT09PT09
PT09CgpkZWYgbG9hZF9lbnYocGF0aDogc3RyKSAtPiBkaWN0OgogICAgIiIiV2luZG93cyAuZW52
IGRvc3lhc8SxbsSxIG9rdXIiIiIKICAgIGVudiA9IHt9CiAgICBpZiBub3Qgb3MucGF0aC5leGlz
dHMocGF0aCk6CiAgICAgICAgbG9nZ2luZy53YXJuaW5nKGYiW1dBUk5dIEVudiBkb3N5YXPEsSBi
dWx1bmFtYWTEsToge3BhdGh9IikKICAgICAgICByZXR1cm4gZW52CgogICAgdHJ5OgogICAgICAg
IHdpdGggb3BlbihwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAg
IGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBsaW5lID0gbGluZS5zdHJpcCgpCiAgICAg
ICAgICAgICAgICBpZiBub3QgbGluZSBvciBsaW5lLnN0YXJ0c3dpdGgoIiMiKToKICAgICAgICAg
ICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYgIj0iIG5vdCBpbiBsaW5lOgog
ICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBrZXksIHZhbHVlID0g
bGluZS5zcGxpdCgiPSIsIDEpCiAgICAgICAgICAgICAgICBrZXkgPSBrZXkuc3RyaXAoKQogICAg
ICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5zdHJpcCgpLnN0cmlwKCciJykuc3RyaXAoIiciKQog
ICAgICAgICAgICAgICAgZW52W2tleV0gPSB2YWx1ZQogICAgICAgIGxvZ2dpbmcuaW5mbyhmIltJ
TkZPXSBFbnYgZG9zeWFzxLEgecO8a2xlbmRpOiB7cGF0aH0iKQogICAgZXhjZXB0IEV4Y2VwdGlv
biBhcyBlOgogICAgICAgIGxvZ2dpbmcuZXJyb3IoZiJbRVJST1JdIEVudiBkb3N5YXPEsSBva3Vu
dXJrZW4gaGF0YToge2V9IikKICAgIAogICAgcmV0dXJuIGVudgoKCmRlZiBnZXRfcHJpbWFyeV9p
cCgpIC0+IHN0cjoKICAgICIiIldpbmRvd3MndGEgYW5hIElQIGFkcmVzaW5pIGJ1bHVyIiIiCiAg
ICB0cnk6CiAgICAgICAgcyA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQsIHNvY2tldC5T
T0NLX0RHUkFNKQogICAgICAgIHMuY29ubmVjdCgoIjguOC44LjgiLCA4MCkpCiAgICAgICAgaXAg
PSBzLmdldHNvY2tuYW1lKClbMF0KICAgICAgICBzLmNsb3NlKCkKICAgICAgICByZXR1cm4gaXAK
ICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICIxMjcuMC4wLjEiCgoKZGVmIGJh
bl9pcF93aW5kb3dzKGlwOiBzdHIsIHNzaF9wb3J0OiBpbnQgPSAyMik6CiAgICAiIiJXaW5kb3dz
IEZpcmV3YWxsIGlsZSBJUCd5aSBiYW5sYXIiIiIKICAgIHRyeToKICAgICAgICBydWxlX25hbWUg
PSBmIlNTSF9CQU5fe2lwLnJlcGxhY2UoJy4nLCAnXycpfSIKICAgICAgICBjaGVja19jbWQgPSBb
CiAgICAgICAgICAgICJuZXRzaCIsICJhZHZmaXJld2FsbCIsICJmaXJld2FsbCIsICJzaG93Iiwg
InJ1bGUiLAogICAgICAgICAgICBmIm5hbWU9e3J1bGVfbmFtZX0iCiAgICAgICAgXQogICAgICAg
IHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKGNoZWNrX2NtZCwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwg
dGV4dD1UcnVlLCB0aW1lb3V0PTUpCiAgICAgICAgCiAgICAgICAgaWYgIk5vIHJ1bGVzIG1hdGNo
IiBpbiByZXN1bHQuc3Rkb3V0IG9yIHJlc3VsdC5yZXR1cm5jb2RlICE9IDA6CiAgICAgICAgICAg
IGFkZF9jbWQgPSBbCiAgICAgICAgICAgICAgICAibmV0c2giLCAiYWR2ZmlyZXdhbGwiLCAiZmly
ZXdhbGwiLCAiYWRkIiwgInJ1bGUiLAogICAgICAgICAgICAgICAgZiJuYW1lPXtydWxlX25hbWV9
IiwKICAgICAgICAgICAgICAgICJkaXI9aW4iLAogICAgICAgICAgICAgICAgImFjdGlvbj1ibG9j
ayIsCiAgICAgICAgICAgICAgICBmInJlbW90ZWlwPXtpcH0iLAogICAgICAgICAgICAgICAgInBy
b3RvY29sPXRjcCIsCiAgICAgICAgICAgICAgICBmImxvY2FscG9ydD17c3NoX3BvcnR9IiwKICAg
ICAgICAgICAgICAgICJlbmFibGU9eWVzIgogICAgICAgICAgICBdCiAgICAgICAgICAgIHN1YnBy
b2Nlc3MucnVuKGFkZF9jbWQsIGNoZWNrPUZhbHNlLCBjYXB0dXJlX291dHB1dD1UcnVlLCB0aW1l
b3V0PTUpCiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhmIltCQU5dIHtpcH0gV2luZG93cyBGaXJl
d2FsbCBpbGUgYmFubGFuZMSxIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1
cm4gRmFsc2UKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dnaW5nLmVycm9y
KGYiW0VSUk9SXSBJUCBiYW5sYW1hIGhhdGFzxLEgKHtpcH0pOiB7ZX0iKQogICAgICAgIHJldHVy
biBGYWxzZQoKCmRlZiBzZW5kX3RvX3dlYmhvb2sod2ViaG9va191cmw6IHN0ciwgcGF5bG9hZDog
ZGljdCwgbWF4X3JldHJpZXM6IGludCA9IDMpOgogICAgIiIibjhuIHdlYmhvb2snYSBnw7ZuZGVy
aXIsIHJldHJ5IG1la2FuaXptYXPEsSBpbGUiIiIKICAgIGZvciBhdHRlbXB0IGluIHJhbmdlKG1h
eF9yZXRyaWVzKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHIgPSByZXF1ZXN0cy5wb3N0KHdl
Ymhvb2tfdXJsLCBqc29uPXBheWxvYWQsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgci5yYWlzZV9m
b3Jfc3RhdHVzKCkKICAgICAgICAgICAgbG9nZ2luZy5kZWJ1ZyhmIltXRUJIT09LXSBCYcWfYXLE
sWzEsToge3BheWxvYWQuZ2V0KCdldmVudF90eXBlJyl9IikKICAgICAgICAgICAgcmV0dXJuIFRy
dWUKICAgICAgICBleGNlcHQgcmVxdWVzdHMuZXhjZXB0aW9ucy5SZXF1ZXN0RXhjZXB0aW9uIGFz
IGU6CiAgICAgICAgICAgIGlmIGF0dGVtcHQgPCBtYXhfcmV0cmllcyAtIDE6CiAgICAgICAgICAg
ICAgICBsb2dnaW5nLndhcm5pbmcoZiJbV0VCSE9PS10gRGVuZW1lIHthdHRlbXB0ICsgMX0ve21h
eF9yZXRyaWVzfSBiYcWfYXLEsXPEsXouLi4iKQogICAgICAgICAgICAgICAgdGltZS5zbGVlcCgy
KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2luZy5lcnJvcihmIltXRUJI
T09LXSB7bWF4X3JldHJpZXN9IGRlbmVtZSBzb25yYXPEsSBiYcWfYXLEsXPEsXo6IHtlfSIpCiAg
ICAgICAgICAgICAgICBlcnJvcl9sb2cgPSBvcy5wYXRoLmpvaW4oTE9HX0RJUiwgIndlYmhvb2tf
ZXJyb3JzLmxvZyIpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgd2l0
aCBvcGVuKGVycm9yX2xvZywgImEiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAg
ICAgICAgICAgICAgICBmLndyaXRlKGpzb24uZHVtcHMoewogICAgICAgICAgICAgICAgICAgICAg
ICAgICAgInRpbWVzdGFtcCI6IGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpLmlzb2Zvcm1hdCgp
LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImVycm9yIjogc3RyKGUpLAogICAgICAgICAg
ICAgICAgICAgICAgICAgICAgInBheWxvYWQiOiBwYXlsb2FkCiAgICAgICAgICAgICAgICAgICAg
ICAgIH0pICsgIlxuIikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAg
ICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICByZXR1cm4g
RmFsc2UKCgpkZWYgdHJhY2tfZmFpbF9hbmRfY2hlY2tfYmFuKGlwOiBzdHIsIG5vd190czogZmxv
YXQsIHRpbWVfd2luZG93OiBpbnQsIG1heF9hdHRlbXB0czogaW50KToKICAgICIiIkJhxZ9hcsSx
c8SxeiBkZW5lbWVsZXJpIHRha2lwIGVkZXIgdmUgYmFuIGtvbnRyb2zDvCB5YXBhciIiIgogICAg
ZHEgPSBmYWlsX2V2ZW50c1tpcF0KICAgIGRxLmFwcGVuZChub3dfdHMpCiAgICAKICAgIGN1dG9m
ZiA9IG5vd190cyAtIHRpbWVfd2luZG93CiAgICB3aGlsZSBkcSBhbmQgZHFbMF0gPCBjdXRvZmY6
CiAgICAgICAgZHEucG9wbGVmdCgpCiAgICAKICAgIGZhaWxfY291bnQgPSBsZW4oZHEpCiAgICBi
YW5fdHJpZ2dlcmVkID0gZmFpbF9jb3VudCA+PSBtYXhfYXR0ZW1wdHMKICAgIHJldHVybiBmYWls
X2NvdW50LCBiYW5fdHJpZ2dlcmVkCgoKZGVmIHJlYWRfd2luZG93c19ldmVudHMobG9nX25hbWU6
IHN0ciwgZXZlbnRfaWRzOiBsaXN0LCBtYXhfZXZlbnRzOiBpbnQgPSAxMDApOgogICAgIiIiUG93
ZXJTaGVsbCBpbGUgV2luZG93cyBFdmVudCBMb2cnZGFuIGV2ZW50bGVyaSBva3VyIiIiCiAgICBl
dmVudF9pZHNfc3RyID0gIiwiLmpvaW4obWFwKHN0ciwgZXZlbnRfaWRzKSkKICAgICMgUG93ZXJT
aGVsbCBzY3JpcHQgLSAkIGthcmFrdGVybGVyaW5pIGVzY2FwZSBldG1layBpw6dpbiBiYWNrdGlj
ayBrdWxsYW4KICAgIHBzX3RlbXBsYXRlID0gJ0dldC1XaW5FdmVudCAtTG9nTmFtZSAie2xvZ19u
YW1lfSIgLU1heEV2ZW50cyB7bWF4X2V2ZW50c30gLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGlu
dWUgfCBXaGVyZS1PYmplY3Qge3sgYCRfLklkIC1pbiBAKHtldmVudF9pZHNfc3RyfSkgfX0gfCBG
b3JFYWNoLU9iamVjdCB7eyBgJHRpbWUgPSBgJF8uVGltZUNyZWF0ZWQuVG9TdHJpbmcoInl5eXkt
TU0tZGQgSEg6bW06c3MiKTsgYCRpZCA9IGAkXy5JZDsgYCRtc2cgPSBgJF8uTWVzc2FnZTsgYCR4
bWwgPSBgJF8uVG9YbWwoKTsgV3JpdGUtT3V0cHV0ICJgJHRpbWV8YCRpZHxgJHhtbHxgJG1zZyIg
fX0nCiAgICBwc19zY3JpcHQgPSBwc190ZW1wbGF0ZS5mb3JtYXQobG9nX25hbWU9bG9nX25hbWUs
IG1heF9ldmVudHM9bWF4X2V2ZW50cywgZXZlbnRfaWRzX3N0cj1ldmVudF9pZHNfc3RyKQogICAg
CiAgICB0cnk6CiAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oCiAgICAgICAgICAgIFsi
cG93ZXJzaGVsbCIsICItQ29tbWFuZCIsIHBzX3NjcmlwdF0sCiAgICAgICAgICAgIGNhcHR1cmVf
b3V0cHV0PVRydWUsCiAgICAgICAgICAgIHRleHQ9VHJ1ZSwKICAgICAgICAgICAgdGltZW91dD0x
MAogICAgICAgICkKICAgICAgICByZXR1cm4gcmVzdWx0LnN0ZG91dAogICAgZXhjZXB0IEV4Y2Vw
dGlvbiBhcyBlOgogICAgICAgIGxvZ2dpbmcuZXJyb3IoZiJbRVJST1JdIFBvd2VyU2hlbGwgZXZl
bnQgb2t1bWEgaGF0YXPEsToge2V9IikKICAgICAgICByZXR1cm4gIiIKCgpkZWYgcGFyc2VfZXZl
bnRfeG1sKHhtbF9zdHI6IHN0cik6CiAgICAiIiJFdmVudCBYTUwnZGVuIGJpbGdpbGVyaSDDp8Sx
a2FyxLFyIiIiCiAgICBkYXRhID0ge30KICAgIHRyeToKICAgICAgICAjIEJhc2l0IFhNTCBwYXJz
aW5nIChFdmVudERhdGEgacOnaW5kZWtpIERhdGEgZWxlbWVudGxlcmkpCiAgICAgICAgaW1wb3J0
IHhtbC5ldHJlZS5FbGVtZW50VHJlZSBhcyBFVAogICAgICAgIHJvb3QgPSBFVC5mcm9tc3RyaW5n
KHhtbF9zdHIpCiAgICAgICAgCiAgICAgICAgIyBFdmVudERhdGEgacOnaW5kZWtpIERhdGEgZWxl
bWVudGxlcmluaSBidWwKICAgICAgICBmb3IgZGF0YV9lbGVtIGluIHJvb3QuZmluZGFsbCgiLi8v
e2h0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luLzIwMDQvMDgvZXZlbnRzL2V2ZW50fURh
dGEiKToKICAgICAgICAgICAgbmFtZSA9IGRhdGFfZWxlbS5nZXQoIk5hbWUiLCAiIikKICAgICAg
ICAgICAgdmFsdWUgPSBkYXRhX2VsZW0udGV4dCBvciAiIgogICAgICAgICAgICBpZiBuYW1lOgog
ICAgICAgICAgICAgICAgZGF0YVtuYW1lLmxvd2VyKCldID0gdmFsdWUKICAgICAgICAKICAgICAg
ICAjIFN5c3RlbSBpw6dpbmRla2kgYmlsZ2lsZXIKICAgICAgICBzeXN0ZW0gPSByb290LmZpbmQo
Ii4vL3todHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbi8yMDA0LzA4L2V2ZW50cy9ldmVu
dH1TeXN0ZW0iKQogICAgICAgIGlmIHN5c3RlbSBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZl
bnRfaWRfZWxlbSA9IHN5c3RlbS5maW5kKCIuLy97aHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNv
bS93aW4vMjAwNC8wOC9ldmVudHMvZXZlbnR9RXZlbnRJRCIpCiAgICAgICAgICAgIGlmIGV2ZW50
X2lkX2VsZW0gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBkYXRhWyJldmVudF9pZCJdID0g
ZXZlbnRfaWRfZWxlbS50ZXh0CiAgICAgICAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAg
ICAgICAgbG9nZ2luZy5kZWJ1ZyhmIltERUJVR10gWE1MIHBhcnNlIGhhdGFzxLE6IHtlfSIpCiAg
ICAKICAgIHJldHVybiBkYXRhCgoKZGVmIGdldF9wb3dlcnNoZWxsX2hpc3RvcnkodXNlcjogc3Ry
ID0gTm9uZSk6CiAgICAiIiJQb3dlclNoZWxsIGtvbXV0IGdlw6dtacWfaW5pIG9rdXIiIiIKICAg
IGhpc3RvcnlfcGF0aHMgPSBbCiAgICAgICAgciJDOlxVc2Vyc1x7fVxBcHBEYXRhXFJvYW1pbmdc
TWljcm9zb2Z0XFdpbmRvd3NcUG93ZXJTaGVsbFxQU1JlYWRMaW5lXENvbnNvbGVIb3N0X2hpc3Rv
cnkudHh0Ii5mb3JtYXQodXNlciBvciBvcy5nZXRlbnYoIlVTRVJOQU1FIikpLAogICAgICAgIHIi
QzpcVXNlcnNce31cQXBwRGF0YVxSb2FtaW5nXE1pY3Jvc29mdFxXaW5kb3dzXFBvd2VyU2hlbGxc
UFNSZWFkTGluZVxDb25zb2xlSG9zdF9oaXN0b3J5LnR4dCIuZm9ybWF0KG9zLmdldGVudigiVVNF
Uk5BTUUiKSkKICAgIF0KICAgIAogICAgY29tbWFuZHMgPSBbXQogICAgZm9yIGhpc3RfcGF0aCBp
biBoaXN0b3J5X3BhdGhzOgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGhpc3RfcGF0aCk6CiAg
ICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihoaXN0X3BhdGgsICJyIiwg
ZW5jb2Rpbmc9InV0Zi04IiwgZXJyb3JzPSJpZ25vcmUiKSBhcyBmOgogICAgICAgICAgICAgICAg
ICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQogICAgICAgICAgICAgICAgICAgIGNvbW1hbmRzLmV4
dGVuZChsaW5lc1stMTA6XSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAg
ICAgICAgIHBhc3MKICAgIAogICAgcmV0dXJuIGNvbW1hbmRzWy0xMDpdIGlmIGNvbW1hbmRzIGVs
c2UgW10KCgpkZWYgbW9uaXRvcl9wb3dlcnNoZWxsX2hpc3RvcnkoKToKICAgICIiIlBvd2VyU2hl
bGwga29tdXQgZ2XDp21pxZ9pbmkgcGVyaXlvZGlrIG9sYXJhayBrb250cm9sIGVkZXIiIiIKICAg
IGxhc3RfY2hlY2tzID0ge30KICAgIAogICAgd2hpbGUgVHJ1ZToKICAgICAgICB0cnk6CiAgICAg
ICAgICAgICMgVMO8bSBrdWxsYW7EsWPEsWxhcsSxbiBoaXN0b3J5IGRvc3lhbGFyxLFuxLEga29u
dHJvbCBldAogICAgICAgICAgICB1c2Vyc19kaXIgPSByIkM6XFVzZXJzIgogICAgICAgICAgICBp
ZiBvcy5wYXRoLmV4aXN0cyh1c2Vyc19kaXIpOgogICAgICAgICAgICAgICAgZm9yIHVzZXJfZGly
IGluIG9zLmxpc3RkaXIodXNlcnNfZGlyKToKICAgICAgICAgICAgICAgICAgICB1c2VyX3BhdGgg
PSBvcy5wYXRoLmpvaW4odXNlcnNfZGlyLCB1c2VyX2RpcikKICAgICAgICAgICAgICAgICAgICBp
ZiBvcy5wYXRoLmlzZGlyKHVzZXJfcGF0aCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3Rf
ZmlsZSA9IG9zLnBhdGguam9pbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJfcGF0
aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIiQXBwRGF0YVxSb2FtaW5nXE1pY3Jvc29m
dFxXaW5kb3dzXFBvd2VyU2hlbGxcUFNSZWFkTGluZVxDb25zb2xlSG9zdF9oaXN0b3J5LnR4dCIK
ICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBvcy5w
YXRoLmV4aXN0cyhoaXN0X2ZpbGUpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXRpbWUg
PSBvcy5wYXRoLmdldG10aW1lKGhpc3RfZmlsZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAg
IGxhc3RfY2hlY2sgPSBsYXN0X2NoZWNrcy5nZXQoaGlzdF9maWxlLCAwKQogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBtdGltZSA+IGxh
c3RfY2hlY2s6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBZZW5pIGtvbXV0bGFy
IHZhcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKGhpc3RfZmlsZSwgInIiLCBlbmNvZGluZz0i
dXRmLTgiLCBlcnJvcnM9Imlnbm9yZSIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBsaW5lcyA9IGYucmVhZGxpbmVzKCkKICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIG5ld19jb21tYW5kcyA9IGxpbmVzWy01Ol0gICMgU29uIDUga29t
dXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGNtZCBpbiBuZXdfY29tbWFuZHM6CiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2luZy5pbmZvKGYiW1BP
V0VSU0hFTExdIHt1c2VyX2Rpcn06IHtjbWQuc3RyaXAoKX0iKQogICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBsYXN0X2NoZWNrc1toaXN0X2ZpbGVdID0gbXRpbWUKICAg
ICAgICAgICAgCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMzApICAjIDMwIHNhbml5ZWRlIGJpciBr
b250cm9sIGV0CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAg
ICAgICAgICAgbG9nZ2luZy5lcnJvcihmIltFUlJPUl0gUG93ZXJTaGVsbCBoaXN0b3J5IGl6bGVt
ZSBoYXRhc8SxOiB7ZX0iKQogICAgICAgICAgICB0aW1lLnNsZWVwKDYwKQoKCmRlZiBmb2xsb3df
d2luZG93c19ldmVudHMoKToKICAgICIiIldpbmRvd3MgRXZlbnQgTG9nJ2xhcsSxbsSxIHPDvHJl
a2xpIGl6bGVyIiIiCiAgICBsYXN0X2V2ZW50X3RpbWVzID0gewogICAgICAgICJTZWN1cml0eSI6
IGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpLAogICAgICAgICJPcGVuU1NIL09wZXJhdGlvbmFs
IjogZGF0ZXRpbWUubm93KHRpbWV6b25lLnV0YykKICAgIH0KICAgIAogICAgIyDEsHpsZW5lY2Vr
IGV2ZW50IElEJ2xlcmkKICAgIHNlY3VyaXR5X2V2ZW50cyA9IFsKICAgICAgICBFVkVOVF9MT0dP
Tl9TVUNDRVNTLAogICAgICAgIEVWRU5UX0xPR09OX0ZBSUxFRCwKICAgICAgICBFVkVOVF9MT0dP
RkYsCiAgICAgICAgRVZFTlRfUFJPQ0VTU19DUkVBVEUsCiAgICAgICAgRVZFTlRfRklMRV9BQ0NF
U1MsCiAgICAgICAgRVZFTlRfUkVHSVNUUllfQUNDRVNTCiAgICBdCiAgICAKICAgIHNzaF9ldmVu
dHMgPSBbNCwgNSwgNl0gICMgT3BlblNTSCBldmVudCBJRCdsZXJpCiAgICAKICAgIHdoaWxlIFRy
dWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFNlY3VyaXR5IExvZwogICAgICAgICAgICBl
dmVudHMgPSByZWFkX3dpbmRvd3NfZXZlbnRzKCJTZWN1cml0eSIsIHNlY3VyaXR5X2V2ZW50cywg
NTApCiAgICAgICAgICAgIGZvciBsaW5lIGluIGV2ZW50cy5zdHJpcCgpLnNwbGl0KCJcbiIpOgog
ICAgICAgICAgICAgICAgaWYgbm90IGxpbmUgb3IgInwiIG5vdCBpbiBsaW5lOgogICAgICAgICAg
ICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRyeToK
ICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoInwiLCAzKQogICAgICAgICAg
ICAgICAgICAgIGlmIGxlbihwYXJ0cykgPCA0OgogICAgICAgICAgICAgICAgICAgICAgICBjb250
aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGV2ZW50X3RpbWVf
c3RyLCBldmVudF9pZCwgeG1sX2RhdGEsIG1lc3NhZ2UgPSBwYXJ0cwogICAgICAgICAgICAgICAg
ICAgIGV2ZW50X3RpbWUgPSBkYXRldGltZS5zdHJwdGltZShldmVudF90aW1lX3N0ciwgIiVZLSVt
LSVkICVIOiVNOiVTIikKICAgICAgICAgICAgICAgICAgICBldmVudF90aW1lID0gZXZlbnRfdGlt
ZS5yZXBsYWNlKHR6aW5mbz10aW1lem9uZS51dGMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAg
ICAgICAgICAgICAgICAgaWYgZXZlbnRfdGltZSA+IGxhc3RfZXZlbnRfdGltZXNbIlNlY3VyaXR5
Il06CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50X2RhdGEgPSBwYXJzZV9ldmVudF94bWwo
eG1sX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50X2RhdGFbImV2ZW50X2lkIl0g
PSBldmVudF9pZAogICAgICAgICAgICAgICAgICAgICAgICBldmVudF9kYXRhWyJ0aW1lIl0gPSBl
dmVudF90aW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50X2RhdGFbIm1lc3NhZ2UiXSA9
IG1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRfZGF0YVsibG9nX25hbWUiXSA9
ICJTZWN1cml0eSIKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAg
ICAgIHlpZWxkIGV2ZW50X2RhdGEKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9ldmVudF90
aW1lc1siU2VjdXJpdHkiXSA9IGV2ZW50X3RpbWUKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNl
cHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnaW5nLmRlYnVnKGYiW0RFQlVHXSBF
dmVudCBwYXJzZSBoYXRhc8SxOiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAg
ICAgICAgICAgIAogICAgICAgICAgICAjIE9wZW5TU0ggTG9nCiAgICAgICAgICAgIGV2ZW50cyA9
IHJlYWRfd2luZG93c19ldmVudHMoIk9wZW5TU0gvT3BlcmF0aW9uYWwiLCBzc2hfZXZlbnRzLCA1
MCkKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZXZlbnRzLnN0cmlwKCkuc3BsaXQoIlxuIik6CiAg
ICAgICAgICAgICAgICBpZiBub3QgbGluZSBvciAifCIgbm90IGluIGxpbmU6CiAgICAgICAgICAg
ICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdHJ5Ogog
ICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgifCIsIDMpCiAgICAgICAgICAg
ICAgICAgICAgaWYgbGVuKHBhcnRzKSA8IDQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRp
bnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZXZlbnRfdGltZV9z
dHIsIGV2ZW50X2lkLCB4bWxfZGF0YSwgbWVzc2FnZSA9IHBhcnRzCiAgICAgICAgICAgICAgICAg
ICAgZXZlbnRfdGltZSA9IGRhdGV0aW1lLnN0cnB0aW1lKGV2ZW50X3RpbWVfc3RyLCAiJVktJW0t
JWQgJUg6JU06JVMiKQogICAgICAgICAgICAgICAgICAgIGV2ZW50X3RpbWUgPSBldmVudF90aW1l
LnJlcGxhY2UodHppbmZvPXRpbWV6b25lLnV0YykKICAgICAgICAgICAgICAgICAgICAKICAgICAg
ICAgICAgICAgICAgICBpZiBldmVudF90aW1lID4gbGFzdF9ldmVudF90aW1lc1siT3BlblNTSC9P
cGVyYXRpb25hbCJdOgogICAgICAgICAgICAgICAgICAgICAgICBldmVudF9kYXRhID0gcGFyc2Vf
ZXZlbnRfeG1sKHhtbF9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICBldmVudF9kYXRhWyJl
dmVudF9pZCJdID0gZXZlbnRfaWQKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRfZGF0YVsi
dGltZSJdID0gZXZlbnRfdGltZQogICAgICAgICAgICAgICAgICAgICAgICBldmVudF9kYXRhWyJt
ZXNzYWdlIl0gPSBtZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50X2RhdGFbImxv
Z19uYW1lIl0gPSAiT3BlblNTSC9PcGVyYXRpb25hbCIKICAgICAgICAgICAgICAgICAgICAgICAg
CiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIGV2ZW50X2RhdGEKICAgICAgICAgICAgICAg
ICAgICAgICAgbGFzdF9ldmVudF90aW1lc1siT3BlblNTSC9PcGVyYXRpb25hbCJdID0gZXZlbnRf
dGltZQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAg
ICAgICAgIGxvZ2dpbmcuZGVidWcoZiJbREVCVUddIFNTSCBldmVudCBwYXJzZSBoYXRhc8SxOiB7
ZX0iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAg
ICB0aW1lLnNsZWVwKDUpICAjIDUgc2FuaXllZGUgYmlyIGtvbnRyb2wgZXQKICAgICAgICAgICAg
CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnaW5nLmVycm9y
KGYiW0VSUk9SXSBFdmVudCBpemxlbWUgaGF0YXPEsToge2V9IikKICAgICAgICAgICAgdGltZS5z
bGVlcCgxMCkKCgojID09PT09PT09PT09PT09PT09PT09PT09PT0KIyAgQW5hIEZvbmtzaXlvbgoj
ID09PT09PT09PT09PT09PT09PT09PT09PT0KCmRlZiBtYWluKCk6CiAgICAiIiJBbmEgZMO2bmfD
vCIiIgogICAgbG9nZ2luZy5pbmZvKCI9IiAqIDYwKQogICAgbG9nZ2luZy5pbmZvKCJLdWxsYW7E
sWPEsSBBa3Rpdml0ZSDEsHpsZW1lIFNpc3RlbWkgLSBXaW5kb3dzIFNlcnZlciIpCiAgICBsb2dn
aW5nLmluZm8oIj0iICogNjApCiAgICAKICAgICMgLmVudiBkb3N5YXPEsW7EsSB5w7xrbGUKICAg
IGVudiA9IGxvYWRfZW52KEVOVl9QQVRIKQogICAgCiAgICAjIEdlcmVrbGkgYXlhcmxhcsSxIGtv
bnRyb2wgZXQKICAgIHdlYmhvb2tfdXJsID0gZW52LmdldCgiV0VCSE9PS19VUkwiLCAiIikuc3Ry
aXAoKQogICAgaWYgbm90IHdlYmhvb2tfdXJsOgogICAgICAgIGxvZ2dpbmcuZXJyb3IoIltGQVRB
TF0gV0VCSE9PS19VUkwgLmVudiBkb3N5YXPEsW5kYSB0YW7EsW1sxLEgZGXEn2lsISIpCiAgICAg
ICAgbG9nZ2luZy5lcnJvcihmIltGQVRBTF0gTMO8dGZlbiB7RU5WX1BBVEh9IGRvc3lhc8SxbsSx
IGTDvHplbmxleWluLiIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgICMgU3VudWN1IGJpbGdpbGVy
aQogICAgaG9zdG5hbWUgPSBzb2NrZXQuZ2V0aG9zdG5hbWUoKQogICAgcHJpbWFyeV9pcCA9IGdl
dF9wcmltYXJ5X2lwKCkKICAgIHNlcnZlcl9uYW1lID0gZW52LmdldCgiU0VSVkVSX05BTUUiLCAi
Iikuc3RyaXAoKSBvciBob3N0bmFtZQogICAgc2VydmVyX2lwID0gZW52LmdldCgiU0VSVkVSX0lQ
IiwgIiIpLnN0cmlwKCkgb3IgcHJpbWFyeV9pcAogICAgc2VydmVyX2VudiA9IGVudi5nZXQoIlNF
UlZFUl9FTlYiLCAiUHJvZHVjdGlvbiIpCiAgICAKICAgICMgR8O8dmVubGlrIGF5YXJsYXLEsQog
ICAgbWF4X2F0dGVtcHRzID0gaW50KGVudi5nZXQoIk1BWF9BVFRFTVBUUyIsICI1IikpCiAgICB0
aW1lX3dpbmRvd19zZWMgPSBpbnQoZW52LmdldCgiVElNRV9XSU5ET1dfU0VDIiwgIjEyMCIpKQog
ICAgYmFuX2R1cmF0aW9uID0gaW50KGVudi5nZXQoIkJBTl9EVVJBVElPTiIsICIzNjAwIikpCiAg
ICBhbGVydF9vbl9zdWNjZXNzID0gZW52LmdldCgiQUxFUlRfT05fU1VDQ0VTUyIsICIxIikgaW4g
KCIxIiwgInRydWUiLCAiVHJ1ZSIsICJZRVMiLCAieWVzIikKICAgIAogICAgIyDEsHpsZW1lIGF5
YXJsYXLEsQogICAgbW9uaXRvcl9jb21tYW5kcyA9IGVudi5nZXQoIk1PTklUT1JfQ09NTUFORFMi
LCAiMSIpIGluICgiMSIsICJ0cnVlIiwgIlRydWUiLCAiWUVTIiwgInllcyIpCiAgICBtb25pdG9y
X3Byb2Nlc3NlcyA9IGVudi5nZXQoIk1PTklUT1JfUFJPQ0VTU0VTIiwgIjEiKSBpbiAoIjEiLCAi
dHJ1ZSIsICJUcnVlIiwgIllFUyIsICJ5ZXMiKQogICAgbW9uaXRvcl9sb2dpbnMgPSBlbnYuZ2V0
KCJNT05JVE9SX0xPR0lOUyIsICIxIikgaW4gKCIxIiwgInRydWUiLCAiVHJ1ZSIsICJZRVMiLCAi
eWVzIikKICAgIG1vbml0b3JfZmlsZV9hY2Nlc3MgPSBlbnYuZ2V0KCJNT05JVE9SX0ZJTEVfQUND
RVNTIiwgIjAiKSBpbiAoIjEiLCAidHJ1ZSIsICJUcnVlIiwgIllFUyIsICJ5ZXMiKQogICAgCiAg
ICAjIFdoaXRlbGlzdAogICAgd2hpdGVsaXN0X2lwcyA9IFtdCiAgICB3aGl0ZWxpc3Rfc3RyID0g
ZW52LmdldCgiV0hJVEVMSVNUX0lQUyIsICIiKS5zdHJpcCgpCiAgICBpZiB3aGl0ZWxpc3Rfc3Ry
OgogICAgICAgIHdoaXRlbGlzdF9pcHMgPSBbaXAuc3RyaXAoKSBmb3IgaXAgaW4gd2hpdGVsaXN0
X3N0ci5zcGxpdCgiLCIpIGlmIGlwLnN0cmlwKCldCiAgICAKICAgIGxvZ2dpbmcuaW5mbyhmIltJ
TkZPXSBXZWJob29rIFVSTDoge3dlYmhvb2tfdXJsfSIpCiAgICBsb2dnaW5nLmluZm8oZiJbSU5G
T10gU3VudWN1OiB7c2VydmVyX25hbWV9ICh7c2VydmVyX2lwfSkgfCBPcnRhbToge3NlcnZlcl9l
bnZ9IikKICAgIGxvZ2dpbmcuaW5mbyhmIltJTkZPXSBFxZ9pazoge21heF9hdHRlbXB0c30gZGVu
ZW1lIC8ge3RpbWVfd2luZG93X3NlY30gc2FuaXllIikKICAgIGxvZ2dpbmcuaW5mbyhmIltJTkZP
XSDEsHpsZW1lOiBLb211dGxhcj17bW9uaXRvcl9jb21tYW5kc30sIFByb2Nlc3M9e21vbml0b3Jf
cHJvY2Vzc2VzfSwgTG9naW49e21vbml0b3JfbG9naW5zfSIpCiAgICAKICAgICMgUG93ZXJTaGVs
bCBoaXN0b3J5IGl6bGVtZSB0aHJlYWQnaSBiYcWfbGF0CiAgICBpZiBtb25pdG9yX2NvbW1hbmRz
OgogICAgICAgIGhpc3RvcnlfdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9bW9uaXRv
cl9wb3dlcnNoZWxsX2hpc3RvcnksIGRhZW1vbj1UcnVlKQogICAgICAgIGhpc3RvcnlfdGhyZWFk
LnN0YXJ0KCkKICAgICAgICBsb2dnaW5nLmluZm8oIltJTkZPXSBQb3dlclNoZWxsIGtvbXV0IGdl
w6dtacWfaSBpemxlbWUgYmHFn2xhdMSxbGTEsSIpCiAgICAKICAgICMgRXZlbnQgTG9nIGl6bGVt
ZQogICAgbG9nZ2luZy5pbmZvKCJbSU5GT10gV2luZG93cyBFdmVudCBMb2cgaXpsZW1lIGJhxZ9s
YXTEsWzEsXlvci4uLiIpCiAgICAKICAgIHRyeToKICAgICAgICBmb3IgZXZlbnQgaW4gZm9sbG93
X3dpbmRvd3NfZXZlbnRzKCk6CiAgICAgICAgICAgIGV2ZW50X2lkID0gaW50KGV2ZW50LmdldCgi
ZXZlbnRfaWQiLCAwKSkKICAgICAgICAgICAgZXZlbnRfdGltZSA9IGV2ZW50LmdldCgidGltZSIs
IGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpKQogICAgICAgICAgICBtZXNzYWdlID0gZXZlbnQu
Z2V0KCJtZXNzYWdlIiwgIiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEJhc2UgcGF5bG9h
ZAogICAgICAgICAgICBiYXNlX3BheWxvYWQgPSB7CiAgICAgICAgICAgICAgICAidGltZXN0YW1w
IjogZXZlbnRfdGltZS5pc29mb3JtYXQoKSwKICAgICAgICAgICAgICAgICJzZXJ2aWNlIjogInVz
ZXJfYWN0aXZpdHkiLAogICAgICAgICAgICAgICAgInNlcnZlcl9uYW1lIjogc2VydmVyX25hbWUs
CiAgICAgICAgICAgICAgICAic2VydmVyX2lwIjogc2VydmVyX2lwLAogICAgICAgICAgICAgICAg
InNlcnZlcl9lbnYiOiBzZXJ2ZXJfZW52LAogICAgICAgICAgICAgICAgImV2ZW50X2lkIjogZXZl
bnRfaWQsCiAgICAgICAgICAgICAgICAicmF3X2xvZyI6IG1lc3NhZ2UKICAgICAgICAgICAgfQog
ICAgICAgICAgICAKICAgICAgICAgICAgbm93X3RzID0gZXZlbnRfdGltZS50aW1lc3RhbXAoKQog
ICAgICAgICAgICAKICAgICAgICAgICAgIyBMb2dvbiBTdWNjZXNzICg0NjI0KQogICAgICAgICAg
ICBpZiBldmVudF9pZCA9PSBFVkVOVF9MT0dPTl9TVUNDRVNTOgogICAgICAgICAgICAgICAgaWYg
bm90IG1vbml0b3JfbG9naW5zOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAg
ICAgICAgICAKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gZXZlbnQuZ2V0KCJ0YXJnZXR1c2Vy
bmFtZSIsIGV2ZW50LmdldCgic3ViamVjdHVzZXJuYW1lIiwgIiIpKQogICAgICAgICAgICAgICAg
aXAgPSBldmVudC5nZXQoImlwYWRkcmVzcyIsIGV2ZW50LmdldCgiaXAiLCAiIikpCiAgICAgICAg
ICAgICAgICBsb2dvbl90eXBlID0gZXZlbnQuZ2V0KCJsb2dvbnR5cGUiLCAiIikKICAgICAgICAg
ICAgICAgIAogICAgICAgICAgICAgICAgaWYgYWxlcnRfb25fc3VjY2VzcyBhbmQgaXAgYW5kIGlw
IG5vdCBpbiB3aGl0ZWxpc3RfaXBzOgogICAgICAgICAgICAgICAgICAgIGJhc2VfcGF5bG9hZC51
cGRhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAiZXZlbnRfdHlwZSI6ICJsb2dvbl9zdWNj
ZXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAgInVzZXIiOiB1c2VybmFtZSwKICAgICAgICAg
ICAgICAgICAgICAgICAgImlwIjogaXAsCiAgICAgICAgICAgICAgICAgICAgICAgICJsb2dvbl90
eXBlIjogbG9nb25fdHlwZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAg
ICAgc2VuZF90b193ZWJob29rKHdlYmhvb2tfdXJsLCBiYXNlX3BheWxvYWQpCiAgICAgICAgICAg
ICAgICAgICAgbG9nZ2luZy5pbmZvKGYiW0xPR09OXSB7dXNlcm5hbWV9IEAge2lwfSIpCiAgICAg
ICAgICAgIAogICAgICAgICAgICAjIExvZ29uIEZhaWxlZCAoNDYyNSkKICAgICAgICAgICAgZWxp
ZiBldmVudF9pZCA9PSBFVkVOVF9MT0dPTl9GQUlMRUQ6CiAgICAgICAgICAgICAgICBpZiBub3Qg
bW9uaXRvcl9sb2dpbnM6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAg
ICAgIAogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBldmVudC5nZXQoInRhcmdldHVzZXJuYW1l
IiwgZXZlbnQuZ2V0KCJzdWJqZWN0dXNlcm5hbWUiLCAiIikpCiAgICAgICAgICAgICAgICBpcCA9
IGV2ZW50LmdldCgiaXBhZGRyZXNzIiwgZXZlbnQuZ2V0KCJpcCIsICIiKSkKICAgICAgICAgICAg
ICAgIAogICAgICAgICAgICAgICAgaWYgaXAgYW5kIGlwIG5vdCBpbiB3aGl0ZWxpc3RfaXBzOgog
ICAgICAgICAgICAgICAgICAgIGZhaWxfY291bnQsIGJhbl90cmlnZ2VyZWQgPSB0cmFja19mYWls
X2FuZF9jaGVja19iYW4oCiAgICAgICAgICAgICAgICAgICAgICAgIGlwLCBub3dfdHMsIHRpbWVf
d2luZG93X3NlYywgbWF4X2F0dGVtcHRzCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAg
ICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIGJhbl90cmlnZ2VyZWQ6CiAgICAgICAg
ICAgICAgICAgICAgICAgIGJhbl9pcF93aW5kb3dzKGlwKQogICAgICAgICAgICAgICAgICAgIAog
ICAgICAgICAgICAgICAgICAgIGJhc2VfcGF5bG9hZC51cGRhdGUoewogICAgICAgICAgICAgICAg
ICAgICAgICAiZXZlbnRfdHlwZSI6ICJsb2dvbl9mYWlsZWQiLAogICAgICAgICAgICAgICAgICAg
ICAgICAidXNlciI6IHVzZXJuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAiaXAiOiBpcCwK
ICAgICAgICAgICAgICAgICAgICAgICAgImZhaWxfY291bnRfd2luZG93IjogZmFpbF9jb3VudCwK
ICAgICAgICAgICAgICAgICAgICAgICAgImJhbl90cmlnZ2VyZWQiOiBiYW5fdHJpZ2dlcmVkCiAg
ICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBzZW5kX3RvX3dlYmhvb2so
d2ViaG9va191cmwsIGJhc2VfcGF5bG9hZCkKICAgICAgICAgICAgICAgICAgICBsb2dnaW5nLndh
cm5pbmcoZiJbTE9HT04gRkFJTEVEXSB7dXNlcm5hbWV9IEAge2lwfSIpCiAgICAgICAgICAgIAog
ICAgICAgICAgICAjIExvZ29mZiAoNDYzNCkKICAgICAgICAgICAgZWxpZiBldmVudF9pZCA9PSBF
VkVOVF9MT0dPRkY6CiAgICAgICAgICAgICAgICBpZiBtb25pdG9yX2xvZ2luczoKICAgICAgICAg
ICAgICAgICAgICB1c2VybmFtZSA9IGV2ZW50LmdldCgidGFyZ2V0dXNlcm5hbWUiLCBldmVudC5n
ZXQoInN1YmplY3R1c2VybmFtZSIsICIiKSkKICAgICAgICAgICAgICAgICAgICBiYXNlX3BheWxv
YWQudXBkYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgImV2ZW50X3R5cGUiOiAibG9nb2Zm
IiwKICAgICAgICAgICAgICAgICAgICAgICAgInVzZXIiOiB1c2VybmFtZQogICAgICAgICAgICAg
ICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgc2VuZF90b193ZWJob29rKHdlYmhvb2tfdXJs
LCBiYXNlX3BheWxvYWQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFByb2Nlc3MgQ3JlYXRl
ICg0Njg4KQogICAgICAgICAgICBlbGlmIGV2ZW50X2lkID09IEVWRU5UX1BST0NFU1NfQ1JFQVRF
OgogICAgICAgICAgICAgICAgaWYgbW9uaXRvcl9wcm9jZXNzZXM6CiAgICAgICAgICAgICAgICAg
ICAgdXNlcm5hbWUgPSBldmVudC5nZXQoInN1YmplY3R1c2VybmFtZSIsICIiKQogICAgICAgICAg
ICAgICAgICAgIHByb2Nlc3NfbmFtZSA9IGV2ZW50LmdldCgicHJvY2Vzc25hbWUiLCAiIikKICAg
ICAgICAgICAgICAgICAgICBjb21tYW5kX2xpbmUgPSBldmVudC5nZXQoImNvbW1hbmRsaW5lIiwg
IiIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBTYWRlY2Ugw7Zu
ZW1saSBwcm9jZXNzJ2xlcmkgYmlsZGlyIChvcHNpeW9uZWwgZmlsdHJlbGVtZSkKICAgICAgICAg
ICAgICAgICAgICBiYXNlX3BheWxvYWQudXBkYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAg
ImV2ZW50X3R5cGUiOiAicHJvY2Vzc19jcmVhdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAi
dXNlciI6IHVzZXJuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAicHJvY2Vzc19uYW1lIjog
cHJvY2Vzc19uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAiY29tbWFuZF9saW5lIjogY29t
bWFuZF9saW5lCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBzZW5k
X3RvX3dlYmhvb2sod2ViaG9va191cmwsIGJhc2VfcGF5bG9hZCkKICAgICAgICAgICAgICAgICAg
ICBsb2dnaW5nLmluZm8oZiJbUFJPQ0VTU10ge3VzZXJuYW1lfToge3Byb2Nlc3NfbmFtZX0iKQog
ICAgICAgICAgICAKICAgICAgICAgICAgIyBGaWxlIEFjY2VzcyAoNDY2MykKICAgICAgICAgICAg
ZWxpZiBldmVudF9pZCA9PSBFVkVOVF9GSUxFX0FDQ0VTUzoKICAgICAgICAgICAgICAgIGlmIG1v
bml0b3JfZmlsZV9hY2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBldmVudC5n
ZXQoInN1YmplY3R1c2VybmFtZSIsICIiKQogICAgICAgICAgICAgICAgICAgIG9iamVjdF9uYW1l
ID0gZXZlbnQuZ2V0KCJvYmplY3RuYW1lIiwgIiIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAg
ICAgICAgICAgICAgICAgYmFzZV9wYXlsb2FkLnVwZGF0ZSh7CiAgICAgICAgICAgICAgICAgICAg
ICAgICJldmVudF90eXBlIjogImZpbGVfYWNjZXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAg
InVzZXIiOiB1c2VybmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgImZpbGVfcGF0aCI6IG9i
amVjdF9uYW1lCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBzZW5k
X3RvX3dlYmhvb2sod2ViaG9va191cmwsIGJhc2VfcGF5bG9hZCkKICAgICAgICAgICAgCiAgICAg
ICAgICAgICMgU1NIIEV2ZW50cyAoT3BlblNTSC9PcGVyYXRpb25hbCkKICAgICAgICAgICAgZWxp
ZiBldmVudC5nZXQoImxvZ19uYW1lIikgPT0gIk9wZW5TU0gvT3BlcmF0aW9uYWwiOgogICAgICAg
ICAgICAgICAgIyBTU0ggYmHFn2FyxLFzxLF6IGdpcmnFnwogICAgICAgICAgICAgICAgaWYgImZh
aWxlZCIgaW4gbWVzc2FnZS5sb3dlcigpIG9yICJpbnZhbGlkIiBpbiBtZXNzYWdlLmxvd2VyKCk6
CiAgICAgICAgICAgICAgICAgICAgaXBfbWF0Y2ggPSByZS5zZWFyY2gociIoXGQrXC5cZCtcLlxk
K1wuXGQrKSIsIG1lc3NhZ2UpCiAgICAgICAgICAgICAgICAgICAgdXNlcl9tYXRjaCA9IHJlLnNl
YXJjaChyInVzZXJbOlxzXSsoXFMrKSIsIG1lc3NhZ2UsIHJlLklHTk9SRUNBU0UpCiAgICAgICAg
ICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgaXBfbWF0Y2ggYW5kIHVzZXJfbWF0
Y2g6CiAgICAgICAgICAgICAgICAgICAgICAgIGlwID0gaXBfbWF0Y2guZ3JvdXAoMSkKICAgICAg
ICAgICAgICAgICAgICAgICAgdXNlciA9IHVzZXJfbWF0Y2guZ3JvdXAoMSkKICAgICAgICAgICAg
ICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGlwIG5vdCBpbiB3aGl0ZWxp
c3RfaXBzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbF9jb3VudCwgYmFuX3RyaWdn
ZXJlZCA9IHRyYWNrX2ZhaWxfYW5kX2NoZWNrX2JhbigKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBpcCwgbm93X3RzLCB0aW1lX3dpbmRvd19zZWMsIG1heF9hdHRlbXB0cwogICAgICAg
ICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBpZiBiYW5fdHJpZ2dlcmVkOgogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIGJhbl9pcF93aW5kb3dzKGlwKQogICAgICAgICAgICAgICAgICAgICAg
ICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYXNlX3BheWxvYWQudXBkYXRlKHsK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXZlbnRfdHlwZSI6ICJzc2hfZmFpbGVk
X2xvZ2luIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidXNlciI6IHVzZXIsCiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImlwIjogaXAsCiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgImZhaWxfY291bnRfd2luZG93IjogZmFpbF9jb3VudCwKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAiYmFuX3RyaWdnZXJlZCI6IGJhbl90cmlnZ2VyZWQKICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBz
ZW5kX3RvX3dlYmhvb2sod2ViaG9va191cmwsIGJhc2VfcGF5bG9hZCkKICAgICAgICAgICAgICAg
IAogICAgICAgICAgICAgICAgIyBTU0ggYmHFn2FyxLFsxLEgZ2lyacWfCiAgICAgICAgICAgICAg
ICBlbGlmICJhY2NlcHRlZCIgaW4gbWVzc2FnZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAg
IGlwX21hdGNoID0gcmUuc2VhcmNoKHIiKFxkK1wuXGQrXC5cZCtcLlxkKykiLCBtZXNzYWdlKQog
ICAgICAgICAgICAgICAgICAgIHVzZXJfbWF0Y2ggPSByZS5zZWFyY2gociJ1c2VyWzpcc10rKFxT
KykiLCBtZXNzYWdlLCByZS5JR05PUkVDQVNFKQogICAgICAgICAgICAgICAgICAgIAogICAgICAg
ICAgICAgICAgICAgIGlmIGlwX21hdGNoIGFuZCB1c2VyX21hdGNoIGFuZCBhbGVydF9vbl9zdWNj
ZXNzOgogICAgICAgICAgICAgICAgICAgICAgICBpcCA9IGlwX21hdGNoLmdyb3VwKDEpCiAgICAg
ICAgICAgICAgICAgICAgICAgIHVzZXIgPSB1c2VyX21hdGNoLmdyb3VwKDEpCiAgICAgICAgICAg
ICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiBpcCBpbiBmYWlsX2V2ZW50
czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxfZXZlbnRzW2lwXS5jbGVhcigpCiAg
ICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBiYXNlX3BheWxv
YWQudXBkYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJldmVudF90eXBlIjogInNz
aF9zdWNjZXNzX2xvZ2luIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ1c2VyIjogdXNl
ciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpcCI6IGlwCiAgICAgICAgICAgICAgICAg
ICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRfdG9fd2ViaG9vayh3ZWJob29r
X3VybCwgYmFzZV9wYXlsb2FkKQogICAgCiAgICBleGNlcHQgS2V5Ym9hcmRJbnRlcnJ1cHQ6CiAg
ICAgICAgbG9nZ2luZy5pbmZvKCJbSU5GT10gS3VsbGFuxLFjxLEgdGFyYWbEsW5kYW4gZHVyZHVy
dWxkdS4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ2dpbmcuZXJyb3Io
ZiJbRkFUQUxdIEJla2xlbm1leWVuIGhhdGE6IHtlfSIsIGV4Y19pbmZvPVRydWUpCgoKaWYgX19u
YW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIG1haW4oKQoK
'@

# Base64 string'i decode edip Python script'ini olu≈ütur
# Newline karakterlerini kaldƒ±r (base64 satƒ±rlara b√∂l√ºnm√º≈ü olabilir)
$pythonScriptBase64 = $pythonScriptBase64 -replace '\s', ''
$pythonScript = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($pythonScriptBase64))

$pythonScript | Out-File -FilePath $ScriptPath -Encoding UTF8
Write-Host "       Script olu≈üturuldu: $ScriptPath" -ForegroundColor Green

Write-Host ""
Write-Host "[5/8] .env dosyasƒ± olu≈üturuluyor..." -ForegroundColor Yellow
if (-not (Test-Path $EnvPath)) {
    $envContent = @"
# Kullanƒ±cƒ± Aktivite ƒ∞zleme Sistemi - Yapƒ±landƒ±rma Dosyasƒ± (Windows)
# Deƒüi≈üiklik yaptƒ±ktan sonra: Restart-Service UserActivityMonitor

# ============================================
#  ZORUNLU AYARLAR
# ============================================

# n8n webhook URL (zorunlu) - BURAYI D√úZENLEYƒ∞N!
WEBHOOK_URL="https://n8vp.yeb.one/webhook/useractivity"

# ============================================
#  G√úVENLƒ∞K AYARLARI
# ============================================

# Ka√ß ba≈üarƒ±sƒ±z denemeden sonra IP banlansƒ±n?
MAX_ATTEMPTS=5

# Ka√ß saniyelik zaman penceresi i√ßinde sayƒ±lacak? (√∂rn: 120 = 2 dakika)
TIME_WINDOW_SEC=120

# Ban s√ºresi (saniye) - ≈üimdilik sadece bilgi ama√ßlƒ±
BAN_DURATION=3600

# Banlanmayacak IP'ler (virg√ºlle ayrƒ±lmƒ±≈ü)
# √ñrnek: WHITELIST_IPS="1.2.3.4,5.6.7.8"
WHITELIST_IPS=""

# ============================================
#  SUNUCU Bƒ∞LGƒ∞LERƒ∞
# ============================================

# Sunucu adƒ± (bo≈ü bƒ±rakƒ±rsan hostname kullanƒ±lƒ±r)
SERVER_NAME=""

# Sunucu IP (bo≈ü bƒ±rakƒ±rsan otomatik tespit edilir)
SERVER_IP=""

# Ortam bilgisi (Production, Staging, Development vb.)
SERVER_ENV="Production"

# ============================================
#  ƒ∞ZLEME AYARLARI
# ============================================

# Ba≈üarƒ±lƒ± giri≈üler i√ßin de bildirim g√∂nderilsin mi? (1 = evet, 0 = hayƒ±r)
ALERT_ON_SUCCESS=1

# PowerShell komut ge√ßmi≈üini izle? (1 = evet, 0 = hayƒ±r)
MONITOR_COMMANDS=1

# Process olu≈üturma olaylarƒ±nƒ± izle? (1 = evet, 0 = hayƒ±r)
MONITOR_PROCESSES=1

# Login/logout olaylarƒ±nƒ± izle? (1 = evet, 0 = hayƒ±r)
MONITOR_LOGINS=1

# Dosya eri≈üimlerini izle? (1 = evet, 0 = hayƒ±r) - File System Audit gerekir
MONITOR_FILE_ACCESS=0
"@
    $envContent | Out-File -FilePath $EnvPath -Encoding UTF8
    Write-Host "       .env dosyasƒ± olu≈üturuldu: $EnvPath" -ForegroundColor Green
    Write-Host ""
    Write-Host "       ‚ö†Ô∏è  √ñNEMLƒ∞: WEBHOOK_URL'i d√ºzenlemeniz gerekiyor!" -ForegroundColor Yellow
    Write-Host "       Dosya: $EnvPath" -ForegroundColor Yellow
    Write-Host ""
} else {
    Write-Host "       .env dosyasƒ± zaten var, √ºzerine yazƒ±lmadƒ±." -ForegroundColor Gray
}

Write-Host ""
Write-Host "[6/8] NSSM kontrol ediliyor..." -ForegroundColor Yellow
if (-not (Test-Path $NSSMPath)) {
    Write-Host "       NSSM bulunamadƒ±." -ForegroundColor Yellow
    Write-Host ""
    Write-Host "       NSSM'i otomatik indirmeyi deniyoruz..." -ForegroundColor Cyan
    
    # NSSM'i otomatik indirmeyi dene
    $nssmUrl = "https://nssm.cc/release/nssm-2.24.zip"
    $nssmZip = "$InstallDir\nssm.zip"
    $nssmExtract = "$InstallDir\nssm_extract"
    
    try {
        Write-Host "       NSSM indiriliyor..." -ForegroundColor Gray
        Invoke-WebRequest -Uri $nssmUrl -OutFile $nssmZip -UseBasicParsing -TimeoutSec 30
        Expand-Archive -Path $nssmZip -DestinationPath $nssmExtract -Force
        $nssmExe = Get-ChildItem -Path $nssmExtract -Recurse -Filter "nssm.exe" | Select-Object -First 1
        if ($nssmExe) {
            Copy-Item $nssmExe.FullName -Destination $NSSMPath -Force
            Remove-Item $nssmZip -Force -ErrorAction SilentlyContinue
            Remove-Item $nssmExtract -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "       ‚úì NSSM otomatik indirildi ve kuruldu" -ForegroundColor Green
        } else {
            throw "nssm.exe bulunamadƒ±"
        }
    } catch {
        Write-Host "       ‚ö†Ô∏è  Otomatik indirme ba≈üarƒ±sƒ±z, manuel kurulum gerekli" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "       Manuel kurulum:" -ForegroundColor Cyan
        Write-Host "       1. https://nssm.cc/download adresinden indirin" -ForegroundColor White
        Write-Host "       2. nssm.exe dosyasƒ±nƒ± ≈üuraya kopyalayƒ±n:" -ForegroundColor White
        Write-Host "          $NSSMPath" -ForegroundColor White
        Write-Host ""
        Write-Host "       Alternatif: Chocolatey ile kurulum:" -ForegroundColor Cyan
        Write-Host "       choco install nssm" -ForegroundColor White
        Write-Host ""
        
        $continue = Read-Host "       NSSM'i manuel olarak indirdiniz mi? (E/H)"
        if ($continue -ne "E" -and $continue -ne "e") {
            Write-Host "[HATA] NSSM gerekli, kurulum iptal edildi." -ForegroundColor Red
            exit 1
        }
        
        if (-not (Test-Path $NSSMPath)) {
            Write-Host "[HATA] NSSM hala bulunamadƒ±: $NSSMPath" -ForegroundColor Red
            exit 1
        }
    }
} else {
    Write-Host "       ‚úì NSSM bulundu" -ForegroundColor Green
}

Write-Host ""
Write-Host "[7/8] Windows Service kuruluyor..." -ForegroundColor Yellow

$existingService = Get-Service -Name $ServiceName -ErrorAction SilentlyContinue
if ($existingService) {
    Write-Host "       Mevcut servis durduruluyor..." -ForegroundColor Gray
    Stop-Service -Name $ServiceName -Force -ErrorAction SilentlyContinue
    Start-Sleep -Seconds 2
    Write-Host "       Mevcut servis kaldƒ±rƒ±lƒ±yor..." -ForegroundColor Gray
    & $NSSMPath remove $ServiceName confirm
}

Write-Host "       Servis y√ºkleniyor..." -ForegroundColor Gray
& $NSSMPath install $ServiceName $pythonPath $ScriptPath

if ($LASTEXITCODE -ne 0) {
    Write-Host "[HATA] Servis kurulumu ba≈üarƒ±sƒ±z!" -ForegroundColor Red
    exit 1
}

Write-Host "       Servis ayarlarƒ± yapƒ±landƒ±rƒ±lƒ±yor..." -ForegroundColor Gray
& $NSSMPath set $ServiceName AppDirectory $InstallDir
& $NSSMPath set $ServiceName DisplayName "User Activity Monitor"
& $NSSMPath set $ServiceName Description "Comprehensive User Activity Monitor with n8n webhook and auto-ban for Windows"
& $NSSMPath set $ServiceName Start SERVICE_AUTO_START
& $NSSMPath set $ServiceName AppStdout "$LogDir\service_stdout.log"
& $NSSMPath set $ServiceName AppStderr "$LogDir\service_stderr.log"

Write-Host ""
Write-Host "[8/8] Servis ba≈ülatƒ±lƒ±yor..." -ForegroundColor Yellow
Start-Service -Name $ServiceName

Start-Sleep -Seconds 2

$service = Get-Service -Name $ServiceName -ErrorAction SilentlyContinue
if ($service -and $service.Status -eq "Running") {
    Write-Host ""
    Write-Host "========================================" -ForegroundColor Green
    Write-Host "‚úì Kurulum ba≈üarƒ±yla tamamlandƒ±!" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Green
    Write-Host ""
    Write-Host "Servis Bilgileri:" -ForegroundColor Cyan
    Write-Host "  Adƒ±: $ServiceName" -ForegroundColor White
    Write-Host "  Durum: $($service.Status)" -ForegroundColor White
    Write-Host "  Script: $ScriptPath" -ForegroundColor White
    Write-Host "  Config: $EnvPath" -ForegroundColor White
    Write-Host "  Loglar: $LogDir" -ForegroundColor White
    Write-Host ""
    Write-Host "Yararlƒ± Komutlar:" -ForegroundColor Cyan
    Write-Host "  Servis durumu:     Get-Service $ServiceName" -ForegroundColor White
    Write-Host "  Servis durdur:     Stop-Service $ServiceName" -ForegroundColor White
    Write-Host "  Servis ba≈ülat:     Start-Service $ServiceName" -ForegroundColor White
    Write-Host "  Servis yeniden:    Restart-Service $ServiceName" -ForegroundColor White
    Write-Host "  Loglarƒ± g√∂r√ºnt√ºle: Get-Content $LogDir\activity_monitor.log -Tail 50" -ForegroundColor White
    Write-Host ""
    Write-Host "‚ö†Ô∏è  √ñNEMLƒ∞: .env dosyasƒ±nda WEBHOOK_URL'i d√ºzenleyin!" -ForegroundColor Yellow
    Write-Host "   Dosya: $EnvPath" -ForegroundColor Yellow
    Write-Host "   D√ºzenleme sonrasƒ±: Restart-Service $ServiceName" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "üìù √ñrnek:" -ForegroundColor Cyan
    Write-Host "   notepad $EnvPath" -ForegroundColor White
    Write-Host "   # WEBHOOK_URL=`"https://your-n8n-url.com/webhook/...`" satƒ±rƒ±nƒ± d√ºzenleyin" -ForegroundColor White
    Write-Host "   Restart-Service $ServiceName" -ForegroundColor White
    Write-Host ""
} else {
    Write-Host ""
    Write-Host "[UYARI] Servis kuruldu ancak ba≈ülatƒ±lamadƒ±!" -ForegroundColor Yellow
    Write-Host "        L√ºtfen manuel olarak kontrol edin:" -ForegroundColor Yellow
    Write-Host "        Get-Service $ServiceName" -ForegroundColor White
    Write-Host "        Get-Content $LogDir\service_stderr.log" -ForegroundColor White
}

