# Kullanƒ±cƒ± Aktivite ƒ∞zleme Sistemi - Windows Server
# Tek Komutla Otomatik Kurulum
# Kullanƒ±m: PowerShell'i Y√∂netici olarak a√ßƒ±n ve √ßalƒ±≈ütƒ±rƒ±n:
#   .\install_windows.ps1
# Veya: Invoke-WebRequest -Uri "https://your-domain.com/install_windows.ps1" -OutFile install.ps1; .\install.ps1

$ErrorActionPreference = "Stop"

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Kullanƒ±cƒ± Aktivite ƒ∞zleme Sistemi" -ForegroundColor Cyan
Write-Host "Windows - Otomatik Kurulum" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# Y√∂netici kontrol√º
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
if (-not $isAdmin) {
    Write-Host "[HATA] Bu script Y√ñNETƒ∞Cƒ∞ olarak √ßalƒ±≈ütƒ±rƒ±lmalƒ±dƒ±r!" -ForegroundColor Red
    Write-Host "PowerShell'i 'Y√∂netici olarak √ßalƒ±≈ütƒ±r' ile a√ßƒ±n." -ForegroundColor Yellow
    exit 1
}

# Yapƒ±landƒ±rma
$InstallDir = "C:\ProgramData\user_activity_monitor"
$ScriptPath = "$InstallDir\user_activity_monitor.py"
$EnvPath = "$InstallDir\user_activity_monitor.env"
$ServiceName = "UserActivityMonitor"
$NSSMPath = "$InstallDir\nssm.exe"
$LogDir = "$InstallDir\logs"

Write-Host "[1/8] Python kontrol ediliyor..." -ForegroundColor Yellow
try {
    $pythonVersion = python --version 2>&1
    if ($LASTEXITCODE -ne 0) {
        throw "Python bulunamadƒ±"
    }
    Write-Host "       Python bulundu: $pythonVersion" -ForegroundColor Green
    $pythonPath = (Get-Command python).Source
    Write-Host "       Python yolu: $pythonPath" -ForegroundColor Gray
} catch {
    Write-Host "[HATA] Python bulunamadƒ±!" -ForegroundColor Red
    Write-Host "       L√ºtfen Python 3.x kurun: https://www.python.org/downloads/" -ForegroundColor Yellow
    Write-Host "       Kurulum sƒ±rasƒ±nda 'Add Python to PATH' se√ßeneƒüini i≈üaretleyin." -ForegroundColor Yellow
    exit 1
}

Write-Host ""
Write-Host "[2/8] Python paketleri kontrol ediliyor..." -ForegroundColor Yellow
try {
    $null = python -c "import requests" 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "       ‚úì requests y√ºkl√º" -ForegroundColor Green
    } else {
        Write-Host "       requests kuruluyor..." -ForegroundColor Yellow
        python -m pip install requests --quiet
        Write-Host "       ‚úì requests kuruldu" -ForegroundColor Green
    }
} catch {
    Write-Host "[HATA] Paket kurulumu ba≈üarƒ±sƒ±z!" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "[3/8] Kurulum klas√∂r√º olu≈üturuluyor..." -ForegroundColor Yellow
if (-not (Test-Path $InstallDir)) {
    New-Item -ItemType Directory -Path $InstallDir -Force | Out-Null
    Write-Host "       Klas√∂r olu≈üturuldu: $InstallDir" -ForegroundColor Green
} else {
    Write-Host "       Klas√∂r zaten var: $InstallDir" -ForegroundColor Gray
}

if (-not (Test-Path $LogDir)) {
    New-Item -ItemType Directory -Path $LogDir -Force | Out-Null
}

Write-Host ""
Write-Host "[4/8] Python scripti olu≈üturuluyor..." -ForegroundColor Yellow

# Python script i√ßeriƒüi (base64 encoded - PowerShell parser sorunlarƒ±nƒ± √∂nlemek i√ßin)
$pythonScriptBase64 = @'
IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiIKS2Fwc2FtbMSxIEt1bGxhbsSxY8SxIEFrdGl2aXRlIMSw
emxlbWUgU2lzdGVtaSAtIFdpbmRvd3MgU2VydmVyClTDvG0ga3VsbGFuxLFjxLEgYWt0aXZpdGVsZXJp
bmkgaXpsZXI6IGxvZ2luLCBsb2dvdXQsIHByb2Nlc3MsIGZpbGUgYWNjZXNzLCByZWdpc3RyeQoiIiIK
CmltcG9ydCBvcwppbXBvcnQgcmUKaW1wb3J0IGpzb24KaW1wb3J0IHRpbWUKaW1wb3J0IHNvY2tldApp
bXBvcnQgc3VicHJvY2VzcwppbXBvcnQgbG9nZ2luZwppbXBvcnQgdGhyZWFkaW5nCmZyb20gZGF0ZXRp
bWUgaW1wb3J0IGRhdGV0aW1lLCB0aW1lem9uZQpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBkZWZhdWx0
ZGljdCwgZGVxdWUKCnRyeToKICAgIGltcG9ydCByZXF1ZXN0cwpleGNlcHQgSW1wb3J0RXJyb3I6CiAg
ICBwcmludCgiW0VSUk9SXSAncmVxdWVzdHMnIHBha2V0aSBidWx1bmFtYWTEsS4gTMO8dGZlbiAncGlw
IGluc3RhbGwgcmVxdWVzdHMnIMOnYWzEscWfdMSxcsSxbi4iKQogICAgZXhpdCgxKQoKIyA9PT09PT09
PT09PT09PT09PT09PT09PT09CiMgIFlhcMSxbGFuZMSxcm1hCiMgPT09PT09PT09PT09PT09PT09PT09
PT09PQoKRU5WX1BBVEggPSByIkM6XFByb2dyYW1EYXRhXHVzZXJfYWN0aXZpdHlfbW9uaXRvclx1c2Vy
X2FjdGl2aXR5X21vbml0b3IuZW52IgpMT0dfRElSID0gciJDOlxQcm9ncmFtRGF0YVx1c2VyX2FjdGl2
aXR5X21vbml0b3JcbG9ncyIKTE9HX0ZJTEUgPSBvcy5wYXRoLmpvaW4oTE9HX0RJUiwgImFjdGl2aXR5
X21vbml0b3IubG9nIikKCiMgTG9nZ2luZyB5YXDEsWxhbmTEsXJtYXPEsQpvcy5tYWtlZGlycyhMT0df
RElSLCBleGlzdF9vaz1UcnVlKQpsb2dnaW5nLmJhc2ljQ29uZmlnKAogICAgbGV2ZWw9bG9nZ2luZy5J
TkZPLAogICAgZm9ybWF0PSJbJShhc2N0aW1lKXNdIFslKGxldmVsbmFtZSlzXSAlKG1lc3NhZ2UpcyIs
CiAgICBoYW5kbGVycz1bCiAgICAgICAgbG9nZ2luZy5GaWxlSGFuZGxlcihMT0dfRklMRSwgZW5jb2Rp
bmc9InV0Zi04IiksCiAgICAgICAgbG9nZ2luZy5TdHJlYW1IYW5kbGVyKCkKICAgIF0KKQoKIyBXaW5k
b3dzIEV2ZW50IElEJ2xlcmkKRVZFTlRfTE9HT05fU1VDQ0VTUyA9IDQ2MjQKRVZFTlRfTE9HT05fRkFJ
TEVEID0gNDYyNQpFVkVOVF9MT0dPRkYgPSA0NjM0CkVWRU5UX0FDQ09VTlRfTE9DS0VEID0gNDc0MApF
VkVOVF9QUk9DRVNTX0NSRUFURSA9IDQ2ODgKRVZFTlRfRklMRV9BQ0NFU1MgPSA0NjYzICAjIE9iamVj
dCBBY2Nlc3MgKEZpbGUpCkVWRU5UX1JFR0lTVFJZX0FDQ0VTUyA9IDQ2NTcgICMgUmVnaXN0cnkgQWNj
ZXNzCgojIElQIC0+IHNvbiBoYXRhbMSxIGRlbmVtZWxlcmluIHphbWFubGFyxLEKZmFpbF9ldmVudHMg
PSBkZWZhdWx0ZGljdChkZXF1ZSkKCgojID09PT09PT09PT09PT09PT09PT09PT09PT0KIyAgWWFyZMSx
bWPEsSBGb25rc2l5b25sYXIKIyA9PT09PT09PT09PT09PT09PT09PT09PT09CgpkZWYgbG9hZF9lbnYo
cGF0aDogc3RyKSAtPiBkaWN0OgogICAgIiIiV2luZG93cyAuZW52IGRvc3lhc8SxbsSxIG9rdXIiIiIK
ICAgIGVudiA9IHt9CiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMocGF0aCk6CiAgICAgICAgbG9nZ2lu
Zy53YXJuaW5nKGYiW1dBUk5dIEVudiBkb3N5YXPEsSBidWx1bmFtYWTEsToge3BhdGh9IikKICAgICAg
ICByZXR1cm4gZW52CgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihwYXRoLCAiciIsIGVuY29kaW5n
PSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBs
aW5lID0gbGluZS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgbGluZSBvciBsaW5lLnN0YXJ0
c3dpdGgoIiMiKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYg
Ij0iIG5vdCBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAg
ICBrZXksIHZhbHVlID0gbGluZS5zcGxpdCgiPSIsIDEpCiAgICAgICAgICAgICAgICBrZXkgPSBrZXku
c3RyaXAoKQogICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5zdHJpcCgpLnN0cmlwKCciJykuc3Ry
aXAoIiciKQogICAgICAgICAgICAgICAgZW52W2tleV0gPSB2YWx1ZQogICAgICAgIGxvZ2dpbmcuaW5m
byhmIltJTkZPXSBFbnYgZG9zeWFzxLEgecO8a2xlbmRpOiB7cGF0aH0iKQogICAgZXhjZXB0IEV4Y2Vw
dGlvbiBhcyBlOgogICAgICAgIGxvZ2dpbmcuZXJyb3IoZiJbRVJST1JdIEVudiBkb3N5YXPEsSBva3Vu
dXJrZW4gaGF0YToge2V9IikKICAgIAogICAgcmV0dXJuIGVudgoKCmRlZiBnZXRfcHJpbWFyeV9pcCgp
IC0+IHN0cjoKICAgICIiIldpbmRvd3MndGEgYW5hIElQIGFkcmVzaW5pIGJ1bHVyIiIiCiAgICB0cnk6
CiAgICAgICAgcyA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQsIHNvY2tldC5TT0NLX0RHUkFN
KQogICAgICAgIHMuY29ubmVjdCgoIjguOC44LjgiLCA4MCkpCiAgICAgICAgaXAgPSBzLmdldHNvY2tu
YW1lKClbMF0KICAgICAgICBzLmNsb3NlKCkKICAgICAgICByZXR1cm4gaXAKICAgIGV4Y2VwdCBFeGNl
cHRpb246CiAgICAgICAgcmV0dXJuICIxMjcuMC4wLjEiCgoKZGVmIGJhbl9pcF93aW5kb3dzKGlwOiBz
dHIsIHNzaF9wb3J0OiBpbnQgPSAyMik6CiAgICAiIiJXaW5kb3dzIEZpcmV3YWxsIGlsZSBJUCd5aSBi
YW5sYXIiIiIKICAgIHRyeToKICAgICAgICBydWxlX25hbWUgPSBmIlNTSF9CQU5fe2lwLnJlcGxhY2Uo
Jy4nLCAnXycpfSIKICAgICAgICBjaGVja19jbWQgPSBbCiAgICAgICAgICAgICJuZXRzaCIsICJhZHZm
aXJld2FsbCIsICJmaXJld2FsbCIsICJzaG93IiwgInJ1bGUiLAogICAgICAgICAgICBmIm5hbWU9e3J1
bGVfbmFtZX0iCiAgICAgICAgXQogICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKGNoZWNrX2Nt
ZCwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgdGV4dD1UcnVlLCB0aW1lb3V0PTUpCiAgICAgICAgCiAgICAg
ICAgaWYgIk5vIHJ1bGVzIG1hdGNoIiBpbiByZXN1bHQuc3Rkb3V0IG9yIHJlc3VsdC5yZXR1cm5jb2Rl
ICE9IDA6CiAgICAgICAgICAgIGFkZF9jbWQgPSBbCiAgICAgICAgICAgICAgICAibmV0c2giLCAiYWR2
ZmlyZXdhbGwiLCAiZmlyZXdhbGwiLCAiYWRkIiwgInJ1bGUiLAogICAgICAgICAgICAgICAgZiJuYW1l
PXtydWxlX25hbWV9IiwKICAgICAgICAgICAgICAgICJkaXI9aW4iLAogICAgICAgICAgICAgICAgImFj
dGlvbj1ibG9jayIsCiAgICAgICAgICAgICAgICBmInJlbW90ZWlwPXtpcH0iLAogICAgICAgICAgICAg
ICAgInByb3RvY29sPXRjcCIsCiAgICAgICAgICAgICAgICBmImxvY2FscG9ydD17c3NoX3BvcnR9IiwK
ICAgICAgICAgICAgICAgICJlbmFibGU9eWVzIgogICAgICAgICAgICBdCiAgICAgICAgICAgIHN1YnBy
b2Nlc3MucnVuKGFkZF9jbWQsIGNoZWNrPUZhbHNlLCBjYXB0dXJlX291dHB1dD1UcnVlLCB0aW1lb3V0
PTUpCiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhmIltCQU5dIHtpcH0gV2luZG93cyBGaXJld2FsbCBp
bGUgYmFubGFuZMSxIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1cm4gRmFsc2UK
ICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dnaW5nLmVycm9yKGYiW0VSUk9SXSBJ
UCBiYW5sYW1hIGhhdGFzxLEgKHtpcH0pOiB7ZX0iKQogICAgICAgIHJldHVybiBGYWxzZQoKCmRlZiBz
ZW5kX3RvX3dlYmhvb2sod2ViaG9va191cmw6IHN0ciwgcGF5bG9hZDogZGljdCwgbWF4X3JldHJpZXM6
IGludCA9IDMpOgogICAgIiIibjhuIHdlYmhvb2snYSBnw7ZuZGVyaXIsIHJldHJ5IG1la2FuaXptYXPE
sSBpbGUiIiIKICAgIGZvciBhdHRlbXB0IGluIHJhbmdlKG1heF9yZXRyaWVzKToKICAgICAgICB0cnk6
CiAgICAgICAgICAgIHIgPSByZXF1ZXN0cy5wb3N0KHdlYmhvb2tfdXJsLCBqc29uPXBheWxvYWQsIHRp
bWVvdXQ9NSkKICAgICAgICAgICAgci5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICAgICAgbG9nZ2lu
Zy5kZWJ1ZyhmIltXRUJIT09LXSBCYcWfYXLEsWzEsToge3BheWxvYWQuZ2V0KCdldmVudF90eXBlJyl9
IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgcmVxdWVzdHMuZXhjZXB0aW9u
cy5SZXF1ZXN0RXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGlmIGF0dGVtcHQgPCBtYXhfcmV0cmll
cyAtIDE6CiAgICAgICAgICAgICAgICBsb2dnaW5nLndhcm5pbmcoZiJbV0VCSE9PS10gRGVuZW1lIHth
dHRlbXB0ICsgMX0ve21heF9yZXRyaWVzfSBiYcWfYXLEsXPEsXouLi4iKQogICAgICAgICAgICAgICAg
dGltZS5zbGVlcCgyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2luZy5lcnJv
cihmIltXRUJIT09LXSB7bWF4X3JldHJpZXN9IGRlbmVtZSBzb25yYXPEsSBiYcWfYXLEsXPEsXo6IHtl
fSIpCiAgICAgICAgICAgICAgICBlcnJvcl9sb2cgPSBvcy5wYXRoLmpvaW4oTE9HX0RJUiwgIndlYmhv
b2tfZXJyb3JzLmxvZyIpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgd2l0
aCBvcGVuKGVycm9yX2xvZywgImEiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAg
ICAgICAgICAgICBmLndyaXRlKGpzb24uZHVtcHMoewogICAgICAgICAgICAgICAgICAgICAgICAgICAg
InRpbWVzdGFtcCI6IGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpLmlzb2Zvcm1hdCgpLAogICAgICAg
ICAgICAgICAgICAgICAgICAgICAgImVycm9yIjogc3RyKGUpLAogICAgICAgICAgICAgICAgICAgICAg
ICAgICAgInBheWxvYWQiOiBwYXlsb2FkCiAgICAgICAgICAgICAgICAgICAgICAgIH0pICsgIlxuIikK
ICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFz
cwogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgdHJhY2tf
ZmFpbF9hbmRfY2hlY2tfYmFuKGlwOiBzdHIsIG5vd190czogZmxvYXQsIHRpbWVfd2luZG93OiBpbnQs
IG1heF9hdHRlbXB0czogaW50KToKICAgICIiIkJhxZ9hcsSxc8SxeiBkZW5lbWVsZXJpIHRha2lwIGVk
ZXIgdmUgYmFuIGtvbnRyb2zDvCB5YXBhciIiIgogICAgZHEgPSBmYWlsX2V2ZW50c1tpcF0KICAgIGRx
LmFwcGVuZChub3dfdHMpCiAgICAKICAgIGN1dG9mZiA9IG5vd190cyAtIHRpbWVfd2luZG93CiAgICB3
aGlsZSBkcSBhbmQgZHFbMF0gPCBjdXRvZmY6CiAgICAgICAgZHEucG9wbGVmdCgpCiAgICAKICAgIGZh
aWxfY291bnQgPSBsZW4oZHEpCiAgICBiYW5fdHJpZ2dlcmVkID0gZmFpbF9jb3VudCA+PSBtYXhfYXR0
ZW1wdHMKICAgIHJldHVybiBmYWlsX2NvdW50LCBiYW5fdHJpZ2dlcmVkCgoKZGVmIHJlYWRfd2luZG93
c19ldmVudHMobG9nX25hbWU6IHN0ciwgZXZlbnRfaWRzOiBsaXN0LCBtYXhfZXZlbnRzOiBpbnQgPSAx
MDApOgogICAgIiIiUG93ZXJTaGVsbCBpbGUgV2luZG93cyBFdmVudCBMb2cnZGFuIGV2ZW50bGVyaSBv
a3VyIiIiCiAgICBldmVudF9pZHNfc3RyID0gIiwiLmpvaW4obWFwKHN0ciwgZXZlbnRfaWRzKSkKICAg
IHBzX3NjcmlwdCA9IGYiIiIKICAgIEdldC1XaW5FdmVudCAtTG9nTmFtZSAie2xvZ19uYW1lfSIgLU1h
eEV2ZW50cyB7bWF4X2V2ZW50c30gLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUgfCAKICAgIFdo
ZXJlLU9iamVjdCB7eyAkXy5JZCAtaW4gQCh7ZXZlbnRfaWRzX3N0cn0pIH19IHwKICAgIEZvckVhY2gt
T2JqZWN0IHt7CiAgICAgICAgJHRpbWUgPSAkXy5UaW1lQ3JlYXRlZC5Ub1N0cmluZygieXl5eS1NTS1k
ZCBIaDptbTpzcyIpCiAgICAgICAgJGlkID0gJF8uSWQKICAgICAgICAkbXNnID0gJF8uTWVzc2FnZQog
ICAgICAgICR4bWwgPSAkXy5Ub1htbCgpCiAgICAgICAgV3JpdGUtT3V0cHV0ICIkdGltZXwkaWR8JHht
bHwkbXNnIgogICAgfX0KICAgICIiIgogICAgCiAgICB0cnk6CiAgICAgICAgcmVzdWx0ID0gc3VicHJv
Y2Vzcy5ydW4oCiAgICAgICAgICAgIFsicG93ZXJzaGVsbCIsICItQ29tbWFuZCIsIHBzX3NjcmlwdF0s
CiAgICAgICAgICAgIGNhcHR1cmVfb3V0cHV0PVRydWUsCiAgICAgICAgICAgIHRleHQ9VHJ1ZSwKICAgICAg
ICAgICAgdGltZW91dD0xMAogICAgICAgICkKICAgICAgICByZXR1cm4gcmVzdWx0LnN0ZG91dAogICAg
ZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ2dpbmcuZXJyb3IoZiJbRVJST1JdIFBvd2Vy
U2hlbGwgZXZlbnQgb2t1bWEgaGF0YXPEsToge2V9IikKICAgICAgICByZXR1cm4gIiIKCgpkZWYgcGFy
c2VfZXZlbnRfeG1sKHhtbF9zdHI6IHN0cik6CiAgICAiIiJFdmVudCBYTUwnZGVuIGJpbGdpbGVyaSDD
p8Sxa2FyxLFyIiIiCiAgICBkYXRhID0ge30KICAgIHRyeToKICAgICAgICAjIEJhc2l0IFhNTCBwYXJz
aW5nIChFdmVudERhdGEgacOnaW5kZWtpIERhdGEgZWxlbWVudGxlcmkpCiAgICAgICAgaW1wb3J0IHht
bC5ldHJlZS5FbGVtZW50VHJlZSBhcyBFVAogICAgICAgIHJvb3QgPSBFVC5mcm9tc3RyaW5nKHhtbF9z
dHIpCiAgICAgICAgCiAgICAgICAgIyBFdmVudERhdGEgacOnaW5kZWtpIERhdGEgZWxlbWVudGxlcmlu
aSBidWwKICAgICAgICBmb3IgZGF0YV9lbGVtIGluIHJvb3QuZmluZGFsbCgiLi8ve2h0dHA6Ly9zY2hl
bWFzLm1pY3Jvc29mdC5jb20vd2luLzIwMDQvMDgvZXZlbnRzL2V2ZW50fURhdGEiKToKICAgICAgICAgICAg
bmFtZSA9IGRhdGFfZWxlbS5nZXQoIk5hbWUiLCAiIikKICAgICAgICAgICAgdmFsdWUgPSBkYXRhX2Vs
ZW0udGV4dCBvciAiIgogICAgICAgICAgICBpZiBuYW1lOgogICAgICAgICAgICAgICAgZGF0YVtuYW1l
Lmxvd2VyKCldID0gdmFsdWUKICAgICAgICAKICAgICAgICAjIFN5c3RlbSBpw6dpbmRla2kgYmlsZ2ls
ZXIKICAgICAgICBzeXN0ZW0gPSByb290LmZpbmQoIi4vL3todHRwOi8vc2NoZW1hcy5taWNyb3NvZnQu
Y29tL3dpbi8yMDA0LzA4L2V2ZW50cy9ldmVudH1TeXN0ZW0iKQogICAgICAgIGlmIHN5c3RlbSBpcyBu
b3QgTm9uZToKICAgICAgICAgICAgZXZlbnRfaWRfZWxlbSA9IHN5c3RlbS5maW5kKCIuLy97aHR0cDov
L3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW4vMjAwNC8wOC9ldmVudHMvZXZlbnR9RXZlbnRJRCIpCiAg
ICAgICAgICAgIGlmIGV2ZW50X2lkX2VsZW0gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBkYXRh
WyJldmVudF9pZCJdID0gZXZlbnRfaWRfZWxlbS50ZXh0CiAgICAgICAgCiAgICBleGNlcHQgRXhjZXB0
aW9uIGFzIGU6CiAgICAgICAgbG9nZ2luZy5kZWJ1ZyhmIltERUJVR10gWE1MIHBhcnNlIGhhdGFzxLE6
IHtlfSIpCiAgICAKICAgIHJldHVybiBkYXRhCgoKZGVmIGdldF9wb3dlcnNoZWxsX2hpc3RvcnkodXNl
cjogc3RyID0gTm9uZSk6CiAgICAiIiJQb3dlclNoZWxsIGtvbXV0IGdlw6dtacWfaW5pIG9rdXIiIiIK
ICAgIGhpc3RvcnlfcGF0aHMgPSBbCiAgICAgICAgciJDOlxVc2Vyc1x7fVxBcHBEYXRhXFJvYW1pbmdc
TWljcm9zb2Z0XFdpbmRvd3NcUG93ZXJTaGVsbFxQU1JlYWRMaW5lXENvbnNvbGVIb3N0X2hpc3Rvcnku
dHh0Ii5mb3JtYXQodXNlciBvciBvcy5nZXRlbnYoIlVTRVJOQU1FIikpLAogICAgICAgIHIiQzpcVXNl
cnNce31cQXBwRGF0YVxSb2FtaW5nXE1pY3Jvc29mdFxXaW5kb3dzXFBvd2VyU2hlbGxcUFNSZWFkTGlu
ZVxDb25zb2xlSG9zdF9oaXN0b3J5LnR4dCIuZm9ybWF0KG9zLmdldGVudigiVVNFUk5BTUUiKSkKICAg
IF0KICAgIAogICAgY29tbWFuZHMgPSBbXQogICAgZm9yIGhpc3RfcGF0aCBpbiBoaXN0b3J5X3BhdGhz
OgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGhpc3RfcGF0aCk6CiAgICAgICAgICAgIHRyeToKICAg
ICAgICAgICAgICAgIHdpdGggb3BlbihoaXN0X3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IiwgZXJy
b3JzPSJpZ25vcmUiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMo
KQogICAgICAgICAgICAgICAgICAgIGNvbW1hbmRzLmV4dGVuZChsaW5lc1stMTA6XSkKICAgICAgICAg
ICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgIAogICAgcmV0dXJuIGNv
bW1hbmRzWy0xMDpdIGlmIGNvbW1hbmRzIGVsc2UgW10KCgpkZWYgbW9uaXRvcl9wb3dlcnNoZWxsX2hp
c3RvcnkoKToKICAgICIiIlBvd2VyU2hlbGwga29tdXQgZ2XDp21pxZ9pbmkgcGVyaXlvZGlrIG9sYXJh
ayBrb250cm9sIGVkZXIiIiIKICAgIGxhc3RfY2hlY2tzID0ge30KICAgIAogICAgd2hpbGUgVHJ1ZToK
ICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMO8bSBrdWxsYW7EsWPEsWxhcsSxbiBoaXN0b3J5IGRv
c3lhbGFyxLFuxLEga29udHJvbCBldAogICAgICAgICAgICB1c2Vyc19kaXIgPSByIkM6XFVzZXJzIgog
ICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh1c2Vyc19kaXIpOgogICAgICAgICAgICAgICAgZm9y
IHVzZXJfZGlyIGluIG9zLmxpc3RkaXIodXNlcnNfZGlyKToKICAgICAgICAgICAgICAgICAgICB1c2VyX3Bh
dGggPSBvcy5wYXRoLmpvaW4odXNlcnNfZGlyLCB1c2VyX2RpcikKICAgICAgICAgICAgICAgICAgICBp
ZiBvcy5wYXRoLmlzZGlyKHVzZXJfcGF0aCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RfZmlsZSA9
IG9zLnBhdGguam9pbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJfcGF0aCwKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIHIiQXBwRGF0YVxSb2FtaW5nXE1pY3Jvc29mdFxXaW5kb3dzXFBvd2Vy
U2hlbGxcUFNSZWFkTGluZVxDb25zb2xlSG9zdF9oaXN0b3J5LnR4dCIKICAgICAgICAgICAgICAgICAg
ICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhoaXN0X2ZpbGUp
OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXRpbWUgPSBvcy5wYXRoLmdldG10aW1lKGhpc3Rf
ZmlsZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfY2hlY2sgPSBsYXN0X2NoZWNrcy5n
ZXQoaGlzdF9maWxlLCAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBpZiBtdGltZSA+IGxhc3RfY2hlY2s6CiAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICMgWWVuaSBrb211dGxhciB2YXIKICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggb3BlbihoaXN0
X2ZpbGUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IiwgZXJyb3JzPSJpZ25vcmUiKSBhcyBmOgogICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQogICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbW1hbmRzID0gbGluZXNbLTU6XSAgIyBT
b24gNSBrb211dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgY21kIGluIG5ld19jb21tYW5kczoKICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnaW5nLmluZm8oZiJbUE9XRVJT
SEVMTF0ge3VzZXJfZGlyfToge2NtZC5zdHJpcCgpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0X2NoZWNrc1toaXN0X2ZpbGVdID0gbXRpbWUKICAg
ICAgICAgICAgCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMzApICAjIDMwIHNhbml5ZWRlIGJpciBrb250
cm9sIGV0CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAg
ICAgbG9nZ2luZy5lcnJvcihmIltFUlJPUl0gUG93ZXJTaGVsbCBoaXN0b3J5IGl6bGVtZSBoYXRhc8Sx
OiB7ZX0iKQogICAgICAgICAgICB0aW1lLnNsZWVwKDYwKQoKCmRlZiBmb2xsb3dfd2luZG93c19ldmVu
dHMoKToKICAgICIiIldpbmRvd3MgRXZlbnQgTG9nJ2xhcsSxbsSxIHPDvHJla2xpIGl6bGVyIiIiCiAg
ICBsYXN0X2V2ZW50X3RpbWVzID0gewogICAgICAgICJTZWN1cml0eSI6IGRhdGV0aW1lLm5vdyh0aW1l
em9uZS51dGMpLAogICAgICAgICJPcGVuU1NIL09wZXJhdGlvbmFsIjogZGF0ZXRpbWUubm93KHRpbWV6
b25lLnV0YykKICAgIH0KICAgIAogICAgIyDEsHpsZW5lY2VrIGV2ZW50IElEJ2xlcmkKICAgIHNlY3Vy
aXR5X2V2ZW50cyA9IFsKICAgICAgICBFVkVOVF9MT0dPTl9TVUNDRVNTLAogICAgICAgIEVWRU5UX0xP
R09OX0ZBSUxFRCwKICAgICAgICBFVkVOVF9MT0dPRkYsCiAgICAgICAgRVZFTlRfUFJPQ0VTU19DUkVB
VEUsCiAgICAgICAgRVZFTlRfRklMRV9BQ0NFU1MsCiAgICAgICAgRVZFTlRfUkVHSVNUUllfQUNDRVNT
CiAgICBdCiAgICAKICAgIHNzaF9ldmVudHMgPSBbNCwgNSwgNl0gICMgT3BlblNTSCBldmVudCBJRCds
ZXJpCiAgICAKICAgIHdoaWxlIFRydWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFNlY3VyaXR5
IExvZwogICAgICAgICAgICBldmVudHMgPSByZWFkX3dpbmRvd3NfZXZlbnRzKCJTZWN1cml0eSIsIHNl
Y3VyaXR5X2V2ZW50cywgNTApCiAgICAgICAgICAgIGZvciBsaW5lIGluIGV2ZW50cy5zdHJpcCgpLnNw
bGl0KCJcbiIpOgogICAgICAgICAgICAgICAgaWYgbm90IGxpbmUgb3IgInwiIG5vdCBpbiBsaW5lOgog
ICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAg
IHRyeToKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoInwiLCAzKQogICAgICAg
ICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPCA0OgogICAgICAgICAgICAgICAgICAgICAgICBjb250
aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGV2ZW50X3RpbWVfc3Ry
LCBldmVudF9pZCwgeG1sX2RhdGEsIG1lc3NhZ2UgPSBwYXJ0cwogICAgICAgICAgICAgICAgICAgIGV2
ZW50X3RpbWUgPSBkYXRldGltZS5zdHJwdGltZShldmVudF90aW1lX3N0ciwgIiVZLSVtLSVkICVIOiVN
OiVTIikKICAgICAgICAgICAgICAgICAgICBldmVudF90aW1lID0gZXZlbnRfdGltZS5yZXBsYWNlKHR6
aW5mbz10aW1lem9uZS51dGMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYg
ZXZlbnRfdGltZSA+IGxhc3RfZXZlbnRfdGltZXNbIlNlY3VyaXR5Il06CiAgICAgICAgICAgICAgICAg
ICAgICAgIGV2ZW50X2RhdGEgPSBwYXJzZV9ldmVudF94bWwoeG1sX2RhdGEpCiAgICAgICAgICAgICAg
ICAgICAgICAgIGV2ZW50X2RhdGFbImV2ZW50X2lkIl0gPSBldmVudF9pZAogICAgICAgICAgICAgICAg
ICAgICAgICBldmVudF9kYXRhWyJ0aW1lIl0gPSBldmVudF90aW1lCiAgICAgICAgICAgICAgICAgICAg
ICAgIGV2ZW50X2RhdGFbIm1lc3NhZ2UiXSA9IG1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAg
ZXZlbnRfZGF0YVsibG9nX25hbWUiXSA9ICJTZWN1cml0eSIKICAgICAgICAgICAgICAgICAgICAgICAg
CiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIGV2ZW50X2RhdGEKICAgICAgICAgICAgICAgICAg
ICAgICAgbGFzdF9ldmVudF90aW1lc1siU2VjdXJpdHkiXSA9IGV2ZW50X3RpbWUKICAgICAgICAgICAg
ICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2luZy5k
ZWJ1ZyhmIltERUJVR10gRXZlbnQgcGFyc2UgaGF0YXPEsToge2V9IikKICAgICAgICAgICAgICAgICAg
ICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBPcGVuU1NIIExvZwogICAgICAgICAg
ICBldmVudHMgPSByZWFkX3dpbmRvd3NfZXZlbnRzKCJPcGVuU1NIL09wZXJhdGlvbmFsIiwgc3NoX2V2
ZW50cywgNTApCiAgICAgICAgICAgIGZvciBsaW5lIGluIGV2ZW50cy5zdHJpcCgpLnNwbGl0KCJcbiIp
OgogICAgICAgICAgICAgICAgaWYgbm90IGxpbmUgb3IgInwiIG5vdCBpbiBsaW5lOgogICAgICAgICAg
ICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRyeToKICAg
ICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoInwiLCAzKQogICAgICAgICAgICAgICAg
ICAgIGlmIGxlbihwYXJ0cykgPCA0OgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAg
ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGV2ZW50X3RpbWVfc3RyLCBldmVudF9p
ZCwgeG1sX2RhdGEsIG1lc3NhZ2UgPSBwYXJ0cwogICAgICAgICAgICAgICAgICAgIGV2ZW50X3RpbWUg
PSBkYXRldGltZS5zdHJwdGltZShldmVudF90aW1lX3N0ciwgIiVZLSVtLSVkICVIOiVNOiVTIikKICAg
ICAgICAgICAgICAgICAgICBldmVudF90aW1lID0gZXZlbnRfdGltZS5yZXBsYWNlKHR6aW5mbz10aW1l
em9uZS51dGMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgZXZlbnRf
dGltZSA+IGxhc3RfZXZlbnRfdGltZXNbIk9wZW5TU0gvT3BlcmF0aW9uYWwiXToKICAgICAgICAgICAg
ICAgICAgICAgICAgZXZlbnRfZGF0YSA9IHBhcnNlX2V2ZW50X3htbCh4bWxfZGF0YSkKICAgICAgICAg
ICAgICAgICAgICAgICAgZXZlbnRfZGF0YVsiZXZlbnRfaWQiXSA9IGV2ZW50X2lkCiAgICAgICAgICAg
ICAgICAgICAgICAgIGV2ZW50X2RhdGFbInRpbWUiXSA9IGV2ZW50X3RpbWUKICAgICAgICAgICAgICAg
ICAgICAgICAgZXZlbnRfZGF0YVsibWVzc2FnZSJdID0gbWVzc2FnZQogICAgICAgICAgICAgICAgICAg
ICAgICBldmVudF9kYXRhWyJsb2dfbmFtZSJdID0gIk9wZW5TU0gvT3BlcmF0aW9uYWwiCiAgICAgICAg
ICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgZXZlbnRfZGF0YQog
ICAgICAgICAgICAgICAgICAgICAgICBsYXN0X2V2ZW50X3RpbWVzWyJPcGVuU1NIL09wZXJhdGlvbmFs
Il0gPSBldmVudF90aW1lCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAg
ICAgICAgICAgICAgICAgbG9nZ2luZy5kZWJ1ZyhmIltERUJVR10gU1NIIGV2ZW50IHBhcnNlIGhhdGFz
xLE6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAg
ICAgIHRpbWUuc2xlZXAoNSkgICMgNSBzYW5peWVkZSBiaXIga29udHJvbCBldAogICAgICAgICAgICAK
ICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoZiJb
RVJST1JdIEV2ZW50IGl6bGVtZSBoYXRhc8SxOiB7ZX0iKQogICAgICAgICAgICB0aW1lLnNsZWVwKDEw
KQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT0KIyAgQW5hIEZvbmtzaXlvbgojID09PT09PT09PT09
PT09PT09PT09PT09PT0KCmRlZiBtYWluKCk6CiAgICAiIiJBbmEgZMO2bmfDvCIiIgogICAgbG9nZ2lu
Zy5pbmZvKCI9IiAqIDYwKQogICAgbG9nZ2luZy5pbmZvKCJLdWxsYW7EsWPEsSBBa3Rpdml0ZSDEsHps
ZW1lIFNpc3RlbWkgLSBXaW5kb3dzIFNlcnZlciIpCiAgICBsb2dnaW5nLmluZm8oIj0iICogNjApCiAg
ICAKICAgICMgLmVudiBkb3N5YXPEsW7EsSB5w7xrbGUKICAgIGVudiA9IGxvYWRfZW52KEVOVl9QQVRI
KQogICAgCiAgICAjIEdlcmVrbGkgYXlhcmxhcsSxIGtvbnRyb2wgZXQKICAgIHdlYmhvb2tfdXJsID0g
ZW52LmdldCgiV0VCSE9PS19VUkwiLCAiIikuc3RyaXAoKQogICAgaWYgbm90IHdlYmhvb2tfdXJsOgog
ICAgICAgIGxvZ2dpbmcuZXJyb3IoIltGQVRBTF0gV0VCSE9PS19VUkwgLmVudiBkb3N5YXPEsW5kYSB0
YW7EsW1sxLEgZGXEn2lsISIpCiAgICAgICAgbG9nZ2luZy5lcnJvcihmIltGQVRBTF0gTMO8dGZlbiB7
RU5WX1BBVEh9IGRvc3lhc8SxbsSxIGTDvHplbmxleWluLiIpCiAgICAgICAgcmV0dXJuCiAgICAKICAg
ICMgU3VudWN1IGJpbGdpbGVyaQogICAgaG9zdG5hbWUgPSBzb2NrZXQuZ2V0aG9zdG5hbWUoKQogICAg
cHJpbWFyeV9pcCA9IGdldF9wcmltYXJ5X2lwKCkKICAgIHNlcnZlcl9uYW1lID0gZW52LmdldCgiU0VS
VkVSX05BTUUiLCAiIikuc3RyaXAoKSBvciBob3N0bmFtZQogICAgc2VydmVyX2lwID0gZW52LmdldCgi
U0VSVkVSX0lQIiwgIiIpLnN0cmlwKCkgb3IgcHJpbWFyeV9pcAogICAgc2VydmVyX2VudiA9IGVudi5n
ZXQoIlNFUlZFUl9FTlYiLCAiUHJvZHVjdGlvbiIpCiAgICAKICAgICMgR8O8dmVubGlrIGF5YXJsYXLE
sQogICAgbWF4X2F0dGVtcHRzID0gaW50KGVudi5nZXQoIk1BWF9BVFRFTVBUUyIsICI1IikpCiAgICB0
aW1lX3dpbmRvd19zZWMgPSBpbnQoZW52LmdldCgiVElNRV9XSU5ET1dfU0VDIiwgIjEyMCIpKQogICAg
YmFuX2R1cmF0aW9uID0gaW50KGVudi5nZXQoIkJBTl9EVVJBVElPTiIsICIzNjAwIikpCiAgICBhbGVy
dF9vbl9zdWNjZXNzID0gZW52LmdldCgiQUxFUlRfT05fU1VDQ0VTUyIsICIxIikgaW4gKCIxIiwgInRy
dWUiLCAiVHJ1ZSIsICJZRVMiLCAieWVzIikKICAgIAogICAgIyDEsHpsZW1lIGF5YXJsYXLEsQog
ICAgbW9uaXRvcl9jb21tYW5kcyA9IGVudi5nZXQoIk1PTklUT1JfQ09NTUFORFMiLCAiMSIpIGluICgi
MSIsICJ0cnVlIiwgIlRydWUiLCAiWUVTIiwgInllcyIpCiAgICBtb25pdG9yX3Byb2Nlc3NlcyA9IGVu
di5nZXQoIk1PTklUT1JfUFJPQ0VTU0VTIiwgIjEiKSBpbiAoIjEiLCAidHJ1ZSIsICJUcnVlIiwgIllF
UyIsICJ5ZXMiKQogICAgbW9uaXRvcl9sb2dpbnMgPSBlbnYuZ2V0KCJNT05JVE9SX0xPR0lOUyIsICIx
IikgaW4gKCIxIiwgInRydWUiLCAiVHJ1ZSIsICJZRVMiLCAieWVzIikKICAgIG1vbml0b3JfZmlsZV9h
Y2Nlc3MgPSBlbnYuZ2V0KCJNT05JVE9SX0ZJTEVfQUNDRVNTIiwgIjAiKSBpbiAoIjEiLCAidHJ1ZSIs
ICJUcnVlIiwgIllFUyIsICJ5ZXMiKQogICAgCiAgICAjIFdoaXRlbGlzdAogICAgd2hpdGVsaXN0X2lw
cyA9IFtdCiAgICB3aGl0ZWxpc3Rfc3RyID0gZW52LmdldCgiV0hJVEVMSVNUX0lQUyIsICIiKS5zdHJp
cCgpCiAgICBpZiB3aGl0ZWxpc3Rfc3RyOgogICAgICAgIHdoaXRlbGlzdF9pcHMgPSBbaXAuc3RyaXAo
KSBmb3IgaXAgaW4gd2hpdGVsaXN0X3N0ci5zcGxpdCgiLCIpIGlmIGlwLnN0cmlwKCldCiAgICAKICAg
IGxvZ2dpbmcuaW5mbyhmIltJTkZPXSBXZWJob29rIFVSTDoge3dlYmhvb2tfdXJsfSIpCiAgICBsb2dn
aW5nLmluZm8oZiJbSU5GT10gU3VudWN1OiB7c2VydmVyX25hbWV9ICh7c2VydmVyX2lwfSkgfCBPcnRh
bToge3NlcnZlcl9lbnZ9IikKICAgIGxvZ2dpbmcuaW5mbyhmIltJTkZPXSBFxZ9pazoge21heF9hdHRl
bXB0c30gZGVuZW1lIC8ge3RpbWVfd2luZG93X3NlY30gc2FuaXllIikKICAgIGxvZ2dpbmcuaW5mbyhm
IltJTkZPXSBEsHpsZW1lOiBLb211dGxhcj17bW9uaXRvcl9jb21tYW5kc30sIFByb2Nlc3M9e21vbml0
b3JfcHJvY2Vzc2VzfSwgTG9naW49e21vbml0b3JfbG9naW5zfSIpCiAgICAKICAgICMgUG93ZXJTaGVs
bCBoaXN0b3J5IGl6bGVtZSB0aHJlYWQnaSBiYcWfbGF0CiAgICBpZiBtb25pdG9yX2NvbW1hbmRzOgog
ICAgICAgIGhpc3RvcnlfdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9bW9uaXRvcl9wb3dl
cnNoZWxsX2hpc3RvcnksIGRhZW1vbj1UcnVlKQogICAgICAgIGhpc3RvcnlfdGhyZWFkLnN0YXJ0KCkK
ICAgICAgICBsb2dnaW5nLmluZm8oIltJTkZPXSBQb3dlclNoZWxsIGtvbXV0IGdlw6dtacWfaSBpemxl
bWUgYmHFn2xhdMSxbGTEsSIpCiAgICAKICAgICMgRXZlbnQgTG9nIGl6bGVtZQogICAgbG9nZ2luZy5pbmZv
KCJbSU5GT10gV2luZG93cyBFdmVudCBMb2cgaXpsZW1lIGJhxZ9sYXTEsWzEsXlvci4uLiIpCiAgICAK
ICAgIHRyeToKICAgICAgICBmb3IgZXZlbnQgaW4gZm9sbG93X3dpbmRvd3NfZXZlbnRzKCk6CiAgICAg
ICAgICAgIGV2ZW50X2lkID0gaW50KGV2ZW50LmdldCgiZXZlbnRfaWQiLCAwKSkKICAgICAgICAgICAg
ZXZlbnRfdGltZSA9IGV2ZW50LmdldCgidGltZSIsIGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpKQog
ICAgICAgICAgICBtZXNzYWdlID0gZXZlbnQuZ2V0KCJtZXNzYWdlIiwgIiIpCiAgICAgICAgICAgIAog
ICAgICAgICAgICAjIEJhc2UgcGF5bG9hZAogICAgICAgICAgICBiYXNlX3BheWxvYWQgPSB7CiAgICAg
ICAgICAgICAgICAidGltZXN0YW1wIjogZXZlbnRfdGltZS5pc29mb3JtYXQoKSwKICAgICAgICAgICAg
ICAgICJzZXJ2aWNlIjogInVzZXJfYWN0aXZpdHkiLAogICAgICAgICAgICAgICAgInNlcnZlcl9uYW1l
Ijogc2VydmVyX25hbWUsCiAgICAgICAgICAgICAgICAic2VydmVyX2lwIjogc2VydmVyX2lwLAogICAg
ICAgICAgICAgICAgInNlcnZlcl9lbnYiOiBzZXJ2ZXJfZW52LAogICAgICAgICAgICAgICAgImV2
ZW50X2lkIjogZXZlbnRfaWQsCiAgICAgICAgICAgICAgICAicmF3X2xvZyI6IG1lc3NhZ2UKICAgICAg
ICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgbm93X3RzID0gZXZlbnRfdGltZS50aW1lc3Rh
bXAoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb2dvbiBTdWNjZXNzICg0NjI0KQogICAgICAg
ICAgICBpZiBldmVudF9pZCA9PSBFVkVOVF9MT0dPTl9TVUNDRVNTOgogICAgICAgICAgICAgICAgaWYg
bm90IG1vbml0b3JfbG9naW5zOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAg
ICAgICAKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gZXZlbnQuZ2V0KCJ0YXJnZXR1c2VybmFtZSIs
IGV2ZW50LmdldCgic3ViamVjdHVzZXJuYW1lIiwgIiIpKQogICAgICAgICAgICAgICAgaXAgPSBldmVu
dC5nZXQoImlwYWRkcmVzcyIsIGV2ZW50LmdldCgiaXAiLCAiIikpCiAgICAgICAgICAgICAgICBsb2dv
bl90eXBlID0gZXZlbnQuZ2V0KCJsb2dvbnR5cGUiLCAiIikKICAgICAgICAgICAgICAgIAogICAgICAg
ICAgICAgICAgaWYgYWxlcnRfb25fc3VjY2VzcyBhbmQgaXAgYW5kIGlwIG5vdCBpbiB3aGl0ZWxpc3Rf
aXBzOgogICAgICAgICAgICAgICAgICAgIGJhc2VfcGF5bG9hZC51cGRhdGUoewogICAgICAgICAgICAg
ICAgICAgICAgICAiZXZlbnRfdHlwZSI6ICJsb2dvbl9zdWNjZXNzIiwKICAgICAgICAgICAgICAgICAg
ICAgICAgInVzZXIiOiB1c2VybmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgImlwIjogaXAsCiAg
ICAgICAgICAgICAgICAgICAgICAgICJsb2dvbl90eXBlIjogbG9nb25fdHlwZQogICAgICAgICAgICAg
ICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgc2VuZF90b193ZWJob29rKHdlYmhvb2tfdXJsLCBi
YXNlX3BheWxvYWQpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2luZy5pbmZvKGYiW0xPR09OXSB7dXNl
cm5hbWV9IEAge2lwfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExvZ29uIEZhaWxlZCAoNDYy
NSkKICAgICAgICAgICAgZWxpZiBldmVudF9pZCA9PSBFVkVOVF9MT0dPTl9GQUlMRUQ6CiAgICAgICAg
ICAgICAgICBpZiBub3QgbW9uaXRvcl9sb2dpbnM6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUK
ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBldmVudC5nZXQoInRhcmdl
dHVzZXJuYW1lIiwgZXZlbnQuZ2V0KCJzdWJqZWN0dXNlcm5hbWUiLCAiIikpCiAgICAgICAgICAgICAg
ICBpcCA9IGV2ZW50LmdldCgiaXBhZGRyZXNzIiwgZXZlbnQuZ2V0KCJpcCIsICIiKSkKICAgICAgICAg
ICAgICAgIAogICAgICAgICAgICAgICAgaWYgaXAgYW5kIGlwIG5vdCBpbiB3aGl0ZWxpc3RfaXBzOgog
ICAgICAgICAgICAgICAgICAgIGZhaWxfY291bnQsIGJhbl90cmlnZ2VyZWQgPSB0cmFja19mYWlsX2Fu
ZF9jaGVja19iYW4oCiAgICAgICAgICAgICAgICAgICAgICAgIGlwLCBub3dfdHMsIHRpbWVfd2luZG93
X3NlYywgbWF4X2F0dGVtcHRzCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAg
IAogICAgICAgICAgICAgICAgICAgIGlmIGJhbl90cmlnZ2VyZWQ6CiAgICAgICAgICAgICAgICAgICAg
ICAgIGJhbl9pcF93aW5kb3dzKGlwKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAg
ICAgIGJhc2VfcGF5bG9hZC51cGRhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAiZXZlbnRfdHlw
ZSI6ICJsb2dvbl9mYWlsZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAidXNlciI6IHVzZXJuYW1l
LAogICAgICAgICAgICAgICAgICAgICAgICAiaXAiOiBpcCwKICAgICAgICAgICAgICAgICAgICAgICAg
ImZhaWxfY291bnRfd2luZG93IjogZmFpbF9jb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgImJh
bl90cmlnZ2VyZWQiOiBiYW5fdHJpZ2dlcmVkCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAg
ICAgICAgICAgICBzZW5kX3RvX3dlYmhvb2sod2ViaG9va191cmwsIGJhc2VfcGF5bG9hZCkKICAgICAg
ICAgICAgICAgICAgICBsb2dnaW5nLndhcm5pbmcoZiJbTE9HT04gRkFJTEVEXSB7dXNlcm5hbWV9IEAge2lw
fSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExvZ29mZiAoNDYzNCkKICAgICAgICAgICAgZWxp
ZiBldmVudF9pZCA9PSBFVkVOVF9MT0dPRkY6CiAgICAgICAgICAgICAgICBpZiBtb25pdG9yX2xvZ2lu
czoKICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGV2ZW50LmdldCgidGFyZ2V0dXNlcm5hbWUi
LCBldmVudC5nZXQoInN1YmplY3R1c2VybmFtZSIsICIiKSkKICAgICAgICAgICAgICAgICAgICBiYXNl
X3BheWxvYWQudXBkYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgImV2ZW50X3R5cGUiOiAibG9n
b2ZmIiwKICAgICAgICAgICAgICAgICAgICAgICAgInVzZXIiOiB1c2VybmFtZQogICAgICAgICAgICAg
ICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgc2VuZF90b193ZWJob29rKHdlYmhvb2tfdXJsLCBi
YXNlX3BheWxvYWQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFByb2Nlc3MgQ3JlYXRlICg0Njg4
KQogICAgICAgICAgICBlbGlmIGV2ZW50X2lkID09IEVWRU5UX1BST0NFU1NfQ1JFQVRFOgogICAgICAg
ICAgICAgICAgaWYgbW9uaXRvcl9wcm9jZXNzZXM6CiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUg
PSBldmVudC5nZXQoInN1YmplY3R1c2VybmFtZSIsICIiKQogICAgICAgICAgICAgICAgICAgIHByb2Nl
c3NfbmFtZSA9IGV2ZW50LmdldCgicHJvY2Vzc25hbWUiLCAiIikKICAgICAgICAgICAgICAgICAgICBj
b21tYW5kX2xpbmUgPSBldmVudC5nZXQoImNvbW1hbmRsaW5lIiwgIiIpCiAgICAgICAgICAgICAgICAg
ICAgCiAgICAgICAgICAgICAgICAgICAgIyBTYWRlY2Ugw7ZuZW1saSBwcm9jZXNzJ2xlcmkgYmlsZGly
IChvcHNpeW9uZWwgZmlsdHJlbGVtZSkKICAgICAgICAgICAgICAgICAgICBiYXNlX3BheWxvYWQudXBk
YXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgImV2ZW50X3R5cGUiOiAicHJvY2Vzc19jcmVhdGUi
LAogICAgICAgICAgICAgICAgICAgICAgICAidXNlciI6IHVzZXJuYW1lLAogICAgICAgICAgICAgICAg
ICAgICAgICAicHJvY2Vzc19uYW1lIjogcHJvY2Vzc19uYW1lLAogICAgICAgICAgICAgICAgICAgICAg
ICAiY29tbWFuZF9saW5lIjogY29tbWFuZF9saW5lCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAg
ICAgICAgICAgICAgICBzZW5kX3RvX3dlYmhvb2sod2ViaG9va191cmwsIGJhc2VfcGF5bG9hZCkKICAg
ICAgICAgICAgICAgICAgICBsb2dnaW5nLmluZm8oZiJbUFJPQ0VTU10ge3VzZXJuYW1lfToge3Byb2Nl
c3NfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBGaWxlIEFjY2VzcyAoNDY2MykKICAg
ICAgICAgICAgZWxpZiBldmVudF9pZCA9PSBFVkVOVF9GSUxFX0FDQ0VTUzoKICAgICAgICAgICAgICAg
IGlmIG1vbml0b3JfZmlsZV9hY2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBldmVu
dC5nZXQoInN1YmplY3R1c2VybmFtZSIsICIiKQogICAgICAgICAgICAgICAgICAgIG9iamVjdF9uYW1l
ID0gZXZlbnQuZ2V0KCJvYmplY3RuYW1lIiwgIiIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAg
ICAgICAgICAgICAgYmFzZV9wYXlsb2FkLnVwZGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICJl
dmVudF90eXBlIjogImZpbGVfYWNjZXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAgInVzZXIiOiB1
c2VybmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgImZpbGVfcGF0aCI6IG9iamVjdF9uYW1lCiAg
ICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBzZW5kX3RvX3dlYmhvb2sod2Vi
aG9va191cmwsIGJhc2VfcGF5bG9hZCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU1NIIEV2ZW50
cyAoT3BlblNTSC9PcGVyYXRpb25hbCkKICAgICAgICAgICAgZWxpZiBldmVudC5nZXQoImxvZ19uYW1l
IikgPT0gIk9wZW5TU0gvT3BlcmF0aW9uYWwiOgogICAgICAgICAgICAgICAgIyBTU0ggYmHFn2FyxLFz
xLF6IGdpcmnFnwogICAgICAgICAgICAgICAgaWYgImZhaWxlZCIgaW4gbWVzc2FnZS5sb3dlcigpIG9y
ICJpbnZhbGlkIiBpbiBtZXNzYWdlLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgaXBfbWF0Y2gg
PSByZS5zZWFyY2gociIoXGQrXC5cZCtcLlxkK1wuXGQrKSIsIG1lc3NhZ2UpCiAgICAgICAgICAgICAg
ICAgICAgdXNlcl9tYXRjaCA9IHJlLnNlYXJjaChyInVzZXJbOlxzXSsoXFMrKSIsIG1lc3NhZ2Us
IHJlLklHTk9SRUNBU0UpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYg
aXBfbWF0Y2ggYW5kIHVzZXJfbWF0Y2g6CiAgICAgICAgICAgICAgICAgICAgICAgIGlwID0gaXBfbWF0
Y2guZ3JvdXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgdXNlciA9IHVzZXJfbWF0Y2guZ3JvdXAoMSkK
ICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGlwIG5vdCBp
biB3aGl0ZWxpc3RfaXBzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbF9jb3VudCwgYmFu
X3RyaWdnZXJlZCA9IHRyYWNrX2ZhaWxfYW5kX2NoZWNrX2JhbigKICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBpcCwgbm93X3RzLCB0aW1lX3dpbmRvd19zZWMsIG1heF9hdHRlbXB0cwogICAg
ICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBiYW5fdHJpZ2dlcmVkOgogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIGJhbl9pcF93aW5kb3dzKGlwKQogICAgICAgICAgICAgICAgICAgICAgICAg
ICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYXNlX3BheWxvYWQudXBkYXRlKHsKICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAiZXZlbnRfdHlwZSI6ICJzc2hfZmFpbGVkX2xvZ2luIiwK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidXNlciI6IHVzZXIsCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgImlwIjogaXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgImZhaWxfY291bnRfd2luZG93IjogZmFpbF9jb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAiYmFuX3RyaWdnZXJlZCI6IGJhbl90cmlnZ2VyZWQKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kX3RvX3dlYmhvb2sod2Vi
aG9va191cmwsIGJhc2VfcGF5bG9hZCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBT
U0ggYmHFn2FyxLFsxLEgZ2lyacWfCiAgICAgICAgICAgICAgICBlbGlmICJhY2NlcHRlZCIgaW4gbWVz
c2FnZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgIGlwX21hdGNoID0gcmUuc2VhcmNoKHIiKFxk
K1wuXGQrXC5cZCtcLlxkKykiLCBtZXNzYWdlKQogICAgICAgICAgICAgICAgICAgIHVzZXJfbWF0Y2gg
PSByZS5zZWFyY2gociJ1c2VyWzpcc10rKFxTKykiLCBtZXNzYWdlLCByZS5JR05PUkVDQVNFKQogICAg
ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIGlwX21hdGNoIGFuZCB1c2VyX21h
dGNoIGFuZCBhbGVydF9vbl9zdWNjZXNzOgogICAgICAgICAgICAgICAgICAgICAgICBpcCA9IGlwX21h
dGNoLmdyb3VwKDEpCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXIgPSB1c2VyX21hdGNoLmdyb3Vw
KDEpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiBpcCBp
biBmYWlsX2V2ZW50czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxfZXZlbnRzW2lwXS5jbGVh
cigpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBiYXNlX3Bh
eWxvYWQudXBkYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJldmVudF90eXBlIjogInNzaF9z
dWNjZXNzX2xvZ2luIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ1c2VyIjogdXNlciwKICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICJpcCI6IGlwCiAgICAgICAgICAgICAgICAgICAgICAg
IH0pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRfdG9fd2ViaG9vayh3ZWJob29rX3VybCwgYmFz
ZV9wYXlsb2FkKQogICAgCiAgICBleGNlcHQgS2V5Ym9hcmRJbnRlcnJ1cHQ6CiAgICAgICAgbG9nZ2lu
Zy5pbmZvKCJbSU5GT10gS3VsbGFuxLFjxLEgdGFyYWbEsW5kYW4gZHVyZHVydWxkdS4iKQogICAgZXhj
ZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ2dpbmcuZXJyb3IoZiJbRkFUQUxdIEJla2xlbm1l
eWVuIGhhdGE6IHtlfSIsIGV4Y19pbmZvPVRydWUpCgoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoK
ICAgIG1haW4oKQoK
'@

# Base64 string'i decode edip Python script'ini olu≈ütur
$pythonScript = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($pythonScriptBase64))

$pythonScript | Out-File -FilePath $ScriptPath -Encoding UTF8
Write-Host "       Script olu≈üturuldu: $ScriptPath" -ForegroundColor Green

Write-Host ""
Write-Host "[5/8] .env dosyasƒ± olu≈üturuluyor..." -ForegroundColor Yellow
if (-not (Test-Path $EnvPath)) {
    $envContent = @"
# Kullanƒ±cƒ± Aktivite ƒ∞zleme Sistemi - Yapƒ±landƒ±rma Dosyasƒ± (Windows)
# Deƒüi≈üiklik yaptƒ±ktan sonra: Restart-Service UserActivityMonitor

# ============================================
#  ZORUNLU AYARLAR
# ============================================

# n8n webhook URL (zorunlu) - BURAYI D√úZENLEYƒ∞N!
WEBHOOK_URL="https://n8vp.yeb.one/webhook/useractivity"

# ============================================
#  G√úVENLƒ∞K AYARLARI
# ============================================

# Ka√ß ba≈üarƒ±sƒ±z denemeden sonra IP banlansƒ±n?
MAX_ATTEMPTS=5

# Ka√ß saniyelik zaman penceresi i√ßinde sayƒ±lacak? (√∂rn: 120 = 2 dakika)
TIME_WINDOW_SEC=120

# Ban s√ºresi (saniye) - ≈üimdilik sadece bilgi ama√ßlƒ±
BAN_DURATION=3600

# Banlanmayacak IP'ler (virg√ºlle ayrƒ±lmƒ±≈ü)
# √ñrnek: WHITELIST_IPS="1.2.3.4,5.6.7.8"
WHITELIST_IPS=""

# ============================================
#  SUNUCU Bƒ∞LGƒ∞LERƒ∞
# ============================================

# Sunucu adƒ± (bo≈ü bƒ±rakƒ±rsan hostname kullanƒ±lƒ±r)
SERVER_NAME=""

# Sunucu IP (bo≈ü bƒ±rakƒ±rsan otomatik tespit edilir)
SERVER_IP=""

# Ortam bilgisi (Production, Staging, Development vb.)
SERVER_ENV="Production"

# ============================================
#  ƒ∞ZLEME AYARLARI
# ============================================

# Ba≈üarƒ±lƒ± giri≈üler i√ßin de bildirim g√∂nderilsin mi? (1 = evet, 0 = hayƒ±r)
ALERT_ON_SUCCESS=1

# PowerShell komut ge√ßmi≈üini izle? (1 = evet, 0 = hayƒ±r)
MONITOR_COMMANDS=1

# Process olu≈üturma olaylarƒ±nƒ± izle? (1 = evet, 0 = hayƒ±r)
MONITOR_PROCESSES=1

# Login/logout olaylarƒ±nƒ± izle? (1 = evet, 0 = hayƒ±r)
MONITOR_LOGINS=1

# Dosya eri≈üimlerini izle? (1 = evet, 0 = hayƒ±r) - File System Audit gerekir
MONITOR_FILE_ACCESS=0
"@
    $envContent | Out-File -FilePath $EnvPath -Encoding UTF8
    Write-Host "       .env dosyasƒ± olu≈üturuldu: $EnvPath" -ForegroundColor Green
    Write-Host ""
    Write-Host "       ‚ö†Ô∏è  √ñNEMLƒ∞: WEBHOOK_URL'i d√ºzenlemeniz gerekiyor!" -ForegroundColor Yellow
    Write-Host "       Dosya: $EnvPath" -ForegroundColor Yellow
    Write-Host ""
} else {
    Write-Host "       .env dosyasƒ± zaten var, √ºzerine yazƒ±lmadƒ±." -ForegroundColor Gray
}

Write-Host ""
Write-Host "[6/8] NSSM kontrol ediliyor..." -ForegroundColor Yellow
if (-not (Test-Path $NSSMPath)) {
    Write-Host "       NSSM bulunamadƒ±." -ForegroundColor Yellow
    Write-Host ""
    Write-Host "       NSSM'i otomatik indirmeyi deniyoruz..." -ForegroundColor Cyan
    
    # NSSM'i otomatik indirmeyi dene
    $nssmUrl = "https://nssm.cc/release/nssm-2.24.zip"
    $nssmZip = "$InstallDir\nssm.zip"
    $nssmExtract = "$InstallDir\nssm_extract"
    
    try {
        Write-Host "       NSSM indiriliyor..." -ForegroundColor Gray
        Invoke-WebRequest -Uri $nssmUrl -OutFile $nssmZip -UseBasicParsing -TimeoutSec 30
        Expand-Archive -Path $nssmZip -DestinationPath $nssmExtract -Force
        $nssmExe = Get-ChildItem -Path $nssmExtract -Recurse -Filter "nssm.exe" | Select-Object -First 1
        if ($nssmExe) {
            Copy-Item $nssmExe.FullName -Destination $NSSMPath -Force
            Remove-Item $nssmZip -Force -ErrorAction SilentlyContinue
            Remove-Item $nssmExtract -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "       ‚úì NSSM otomatik indirildi ve kuruldu" -ForegroundColor Green
        } else {
            throw "nssm.exe bulunamadƒ±"
        }
    } catch {
        Write-Host "       ‚ö†Ô∏è  Otomatik indirme ba≈üarƒ±sƒ±z, manuel kurulum gerekli" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "       Manuel kurulum:" -ForegroundColor Cyan
        Write-Host "       1. https://nssm.cc/download adresinden indirin" -ForegroundColor White
        Write-Host "       2. nssm.exe dosyasƒ±nƒ± ≈üuraya kopyalayƒ±n:" -ForegroundColor White
        Write-Host "          $NSSMPath" -ForegroundColor White
        Write-Host ""
        Write-Host "       Alternatif: Chocolatey ile kurulum:" -ForegroundColor Cyan
        Write-Host "       choco install nssm" -ForegroundColor White
        Write-Host ""
        
        $continue = Read-Host "       NSSM'i manuel olarak indirdiniz mi? (E/H)"
        if ($continue -ne "E" -and $continue -ne "e") {
            Write-Host "[HATA] NSSM gerekli, kurulum iptal edildi." -ForegroundColor Red
            exit 1
        }
        
        if (-not (Test-Path $NSSMPath)) {
            Write-Host "[HATA] NSSM hala bulunamadƒ±: $NSSMPath" -ForegroundColor Red
            exit 1
        }
    }
} else {
    Write-Host "       ‚úì NSSM bulundu" -ForegroundColor Green
}

Write-Host ""
Write-Host "[7/8] Windows Service kuruluyor..." -ForegroundColor Yellow

$existingService = Get-Service -Name $ServiceName -ErrorAction SilentlyContinue
if ($existingService) {
    Write-Host "       Mevcut servis durduruluyor..." -ForegroundColor Gray
    Stop-Service -Name $ServiceName -Force -ErrorAction SilentlyContinue
    Start-Sleep -Seconds 2
    Write-Host "       Mevcut servis kaldƒ±rƒ±lƒ±yor..." -ForegroundColor Gray
    & $NSSMPath remove $ServiceName confirm
}

Write-Host "       Servis y√ºkleniyor..." -ForegroundColor Gray
& $NSSMPath install $ServiceName $pythonPath $ScriptPath

if ($LASTEXITCODE -ne 0) {
    Write-Host "[HATA] Servis kurulumu ba≈üarƒ±sƒ±z!" -ForegroundColor Red
    exit 1
}

Write-Host "       Servis ayarlarƒ± yapƒ±landƒ±rƒ±lƒ±yor..." -ForegroundColor Gray
& $NSSMPath set $ServiceName AppDirectory $InstallDir
& $NSSMPath set $ServiceName DisplayName "User Activity Monitor"
& $NSSMPath set $ServiceName Description "Comprehensive User Activity Monitor with n8n webhook and auto-ban for Windows"
& $NSSMPath set $ServiceName Start SERVICE_AUTO_START
& $NSSMPath set $ServiceName AppStdout "$LogDir\service_stdout.log"
& $NSSMPath set $ServiceName AppStderr "$LogDir\service_stderr.log"

Write-Host ""
Write-Host "[8/8] Servis ba≈ülatƒ±lƒ±yor..." -ForegroundColor Yellow
Start-Service -Name $ServiceName

Start-Sleep -Seconds 2

$service = Get-Service -Name $ServiceName -ErrorAction SilentlyContinue
if ($service -and $service.Status -eq "Running") {
    Write-Host ""
    Write-Host "========================================" -ForegroundColor Green
    Write-Host "‚úì Kurulum ba≈üarƒ±yla tamamlandƒ±!" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Green
    Write-Host ""
    Write-Host "Servis Bilgileri:" -ForegroundColor Cyan
    Write-Host "  Adƒ±: $ServiceName" -ForegroundColor White
    Write-Host "  Durum: $($service.Status)" -ForegroundColor White
    Write-Host "  Script: $ScriptPath" -ForegroundColor White
    Write-Host "  Config: $EnvPath" -ForegroundColor White
    Write-Host "  Loglar: $LogDir" -ForegroundColor White
    Write-Host ""
    Write-Host "Yararlƒ± Komutlar:" -ForegroundColor Cyan
    Write-Host "  Servis durumu:     Get-Service $ServiceName" -ForegroundColor White
    Write-Host "  Servis durdur:     Stop-Service $ServiceName" -ForegroundColor White
    Write-Host "  Servis ba≈ülat:     Start-Service $ServiceName" -ForegroundColor White
    Write-Host "  Servis yeniden:    Restart-Service $ServiceName" -ForegroundColor White
    Write-Host "  Loglarƒ± g√∂r√ºnt√ºle: Get-Content $LogDir\activity_monitor.log -Tail 50" -ForegroundColor White
    Write-Host ""
    Write-Host "‚ö†Ô∏è  √ñNEMLƒ∞: .env dosyasƒ±nda WEBHOOK_URL'i d√ºzenleyin!" -ForegroundColor Yellow
    Write-Host "   Dosya: $EnvPath" -ForegroundColor Yellow
    Write-Host "   D√ºzenleme sonrasƒ±: Restart-Service $ServiceName" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "üìù √ñrnek:" -ForegroundColor Cyan
    Write-Host "   notepad $EnvPath" -ForegroundColor White
    Write-Host "   # WEBHOOK_URL=`"https://your-n8n-url.com/webhook/...`" satƒ±rƒ±nƒ± d√ºzenleyin" -ForegroundColor White
    Write-Host "   Restart-Service $ServiceName" -ForegroundColor White
    Write-Host ""
} else {
    Write-Host ""
    Write-Host "[UYARI] Servis kuruldu ancak ba≈ülatƒ±lamadƒ±!" -ForegroundColor Yellow
    Write-Host "        L√ºtfen manuel olarak kontrol edin:" -ForegroundColor Yellow
    Write-Host "        Get-Service $ServiceName" -ForegroundColor White
    Write-Host "        Get-Content $LogDir\service_stderr.log" -ForegroundColor White
}

